============================= test session starts =============================
platform win32 -- Python 3.11.4, pytest-8.4.1, pluggy-1.6.0
rootdir: D:\workspace_projects_001\dermasync-api
configfile: pytest.ini
plugins: anyio-4.9.0, langsmith-0.4.5, asyncio-1.0.0, cov-6.2.1, html-4.1.1, json-report-1.5.0, logger-1.1.1, metadata-3.1.1, mock-3.15.1
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function

----------------------------- live log collection -----------------------------
2026-01-27 14:11:44 [INFO] Current Python path: ['D:\\workspace_projects_001\\dermasync-api', 'D:\\workspace_projects_001\\dermasync-api\\tests\\services', 'D:\\workspace_projects_001\\dermasync-api\\tests\\services\\readmodels', 'D:\\workspace_projects_001\\dermasync-api\\tests\\services\\effects', 'D:\\workspace_projects_001\\dermasync-api\\tests\\routes', 'D:\\workspace_projects_001\\dermasync-api\\tests\\integration', 'D:\\workspace_projects_001\\dermasync-api\\tests\\infra\\retry', 'D:\\workspace_projects_001\\dermasync-api\\tests\\domain', 'D:\\workspace_projects_001\\dermasync-api\\tests\\domain\\ux_effects', 'D:\\workspace_projects_001\\dermasync-api\\tests\\domain\\relato', 'D:\\workspace_projects_001\\dermasync-api\\tests\\domain', 'D:\\workspace_projects_001\\dermasync-api\\tests\\domain\\effects', 'D:\\workspace_projects_001\\dermasync-api\\tests\\core\\projections', 'D:\\workspace_projects_001\\dermasync-api\\tests\\auth', 'D:\\workspace_projects_001\\dermasync-api\\tests\\application', 'D:\\workspace_projects_001\\dermasync-api', 'D:\\workspace_projects_001\\dermasync-api\\venv\\Scripts\\pytest.exe', 'C:\\Python311\\python311.zip', 'C:\\Python311\\DLLs', 'C:\\Python311\\Lib', 'C:\\Python311', 'D:\\workspace_projects_001\\dermasync-api\\venv', 'D:\\workspace_projects_001\\dermasync-api\\venv\\Lib\\site-packages', 'D:\\workspace_projects_001\\dermasync-api\\app\\pipeline']
collected 155 items

tests/application/test_relato_progress_service.py::test_service_returns_progress_with_no_effects PASSED [  0%]
tests/application/test_relato_progress_service.py::test_service_passes_effects_to_domain_correctly PASSED [  1%]
tests/application/test_relato_progress_service.py::test_service_calls_repository_with_correct_relato_id PASSED [  1%]
tests/application/test_relato_progress_service.py::test_service_propagates_repository_errors PASSED [  2%]
tests/application/test_relato_progress_stabilization_service.py::test_job_returns_snapshot_if_stable_exists PASSED [  3%]
tests/application/test_relato_progress_stabilization_service.py::test_job_persists_snapshot_when_progress_is_stable FAILED [  3%]
tests/auth/test_auth_cenarios.py::test_get_me_usuario_nao_encontrado 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:45 [INFO] Auth token payload preview: sub=8fff5fa7-8f4d-48bb-9423-6430a68276d7 role=usuario_logado type=access
2026-01-27 14:11:45 [WARNING] auth_service.get_user_from_db levantou HTTPException: Usu├írio n├úo encontrado. (status=401)
2026-01-27 14:11:46 [INFO] AUTH REJECT: usu├írio n├úo encontrado (sub=8fff5fa7-8f4d-48bb-9423-6430a68276d7). (service_used=True)
2026-01-27 14:11:46 [INFO] GET /auth/me 127.0.0.1 -> 401 (107.5ms) body_len=0
2026-01-27 14:11:46 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [  4%]
tests/auth/test_auth_cenarios.py::test_get_me_usuario_desativado_apos_login 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [INFO] Auth token payload preview: sub=3d9fe4da-698d-4a7e-9f14-913721f39d4b role=usuario_logado type=access
2026-01-27 14:11:46 [INFO] AUTH FORBID: usu├írio inativo user=3d9fe4da-698d-4a7e-9f14-913721f39d4b
2026-01-27 14:11:46 [INFO] GET /auth/me 127.0.0.1 -> 403 (11.7ms) body_len=0
2026-01-27 14:11:46 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 403 Forbidden"
PASSED                                                                   [  5%]
tests/auth/test_auth_cenarios.py::test_external_login_com_usuario_inativo 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [INFO] POST /auth/external-login 127.0.0.1 -> 403 (11.4ms) body_len=40
2026-01-27 14:11:46 [INFO] HTTP Request: POST http://test/auth/external-login "HTTP/1.1 403 Forbidden"
PASSED                                                                   [  5%]
tests/auth/test_auth_cenarios.py::test_role_mismatch_entre_token_e_db 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [INFO] Auth token payload preview: sub=16378636-4223-40ea-a298-43bdb511b2a8 role=admin type=access
2026-01-27 14:11:46 [WARNING] AUTH REJECT: mismatch entre role do token (admin) e role do DB (usuario_logado) para user=16378636-4223-40ea-a298-43bdb511b2a8
2026-01-27 14:11:46 [INFO] GET /auth/me 127.0.0.1 -> 401 (15.0ms) body_len=0
2026-01-27 14:11:46 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [  6%]
tests/auth/test_auth_cenarios.py::test_get_me_com_auth_header_invalido[None-Not authenticated] 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:11:46 [INFO] GET /auth/me 127.0.0.1 -> 401 (16.4ms) body_len=0
2026-01-27 14:11:46 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [  7%]
tests/auth/test_auth_cenarios.py::test_get_me_com_auth_header_invalido[Token my-invalid-token-Not authenticated] 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [INFO] AUTH REJECT: Authorization header presente mas esquema n├úo ├® Bearer (esquema=token).
2026-01-27 14:11:46 [INFO] GET /auth/me 127.0.0.1 -> 401 (8.1ms) body_len=0
2026-01-27 14:11:46 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [  7%]
tests/auth/test_auth_cenarios.py::test_get_me_com_auth_header_invalido[Bearer -Token inv\xe1lido.] 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [INFO] AUTH REJECT: Bearer header presente mas token vazio.
2026-01-27 14:11:46 [INFO] GET /auth/me 127.0.0.1 -> 401 (9.5ms) body_len=0
2026-01-27 14:11:46 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [  8%]
tests/auth/test_auth_cenarios.py::test_get_me_com_auth_header_invalido[Bearer-Token inv\xe1lido.] 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [INFO] AUTH REJECT: Bearer header presente mas token vazio.
2026-01-27 14:11:46 [INFO] GET /auth/me 127.0.0.1 -> 401 (34.7ms) body_len=0
2026-01-27 14:11:46 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [  9%]
tests/auth/test_auth_flow.py::test_auth_flow_end_to_end_and_log_stdout 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:46 [WARNING] (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\passlib\handlers\bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2026-01-27 14:11:47 [INFO] Tentativa de login recebida para o e-mail: test+85e7ebec@local.com
2026-01-27 14:11:48 [INFO] Token de acesso e refresh emitidos para o usu├írio: test+85e7ebec@local.com
2026-01-27 14:11:48 [INFO] POST /auth/login testclient -> 200 (1058.9ms) body_len=58
2026-01-27 14:11:48 [INFO] HTTP Request: POST http://testserver/auth/login "HTTP/1.1 200 OK"
2026-01-27 14:11:48 [INFO] Auth token payload preview: sub=05c6125b-5c57-413f-9f14-0894d9d7559d role=usuario_logado type=access
2026-01-27 14:11:48 [WARNING] auth_service.get_user_from_db levantou HTTPException: Usu├írio n├úo encontrado. (status=401)
2026-01-27 14:11:48 [INFO] AUTH OK: usu├írio autenticado user=05c6125b-5c57-413f-9f14-0894d9d7559d role=usuario_logado (service_used=True)
2026-01-27 14:11:48 [INFO] GET /me/profile testclient -> 200 (690.7ms) body_len=0
2026-01-27 14:11:48 [INFO] HTTP Request: GET http://testserver/me/profile "HTTP/1.1 200 OK"
PASSED                                                                   [  9%]
tests/auth/test_auth_hardening.py::test_auth_refresh_expired PASSED      [ 10%]
tests/auth/test_auth_hardening.py::test_auth_refresh_reuse PASSED        [ 10%]
tests/auth/test_auth_hardening.py::test_auth_revoke_all_tokens PASSED    [ 11%]
tests/auth/test_auth_logout.py::test_auth_logout_revokes_refresh_token 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:51 [INFO] POST /auth/logout 127.0.0.1 -> 200 (36.1ms) body_len=106
2026-01-27 14:11:51 [INFO] HTTP Request: POST http://test/auth/logout "HTTP/1.1 200 OK"
PASSED                                                                   [ 12%]
tests/auth/test_auth_logout.py::test_auth_logout_idempotent 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:51 [INFO] POST /auth/logout 127.0.0.1 -> 200 (36.7ms) body_len=106
2026-01-27 14:11:51 [INFO] HTTP Request: POST http://test/auth/logout "HTTP/1.1 200 OK"
2026-01-27 14:11:51 [INFO] POST /auth/logout 127.0.0.1 -> 200 (10.5ms) body_len=106
2026-01-27 14:11:51 [INFO] HTTP Request: POST http://test/auth/logout "HTTP/1.1 200 OK"
PASSED                                                                   [ 12%]
tests/auth/test_auth_logout.py::test_auth_logout_all_revokes_all_and_invalidates_access 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:52 [INFO] POST /auth/logout-all 127.0.0.1 -> 200 (36.6ms) body_len=0
2026-01-27 14:11:52 [INFO] HTTP Request: POST http://test/auth/logout-all "HTTP/1.1 200 OK"
PASSED                                                                   [ 13%]
tests/auth/test_auth_logout.py::test_auth_logout_all_requires_auth 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:52 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:11:52 [INFO] POST /auth/logout-all 127.0.0.1 -> 401 (6.5ms) body_len=0
2026-01-27 14:11:52 [INFO] HTTP Request: POST http://test/auth/logout-all "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 14%]
tests/auth/test_auth_refresh.py::test_refresh_token_sucesso 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:52 [INFO] POST /auth/refresh 127.0.0.1 -> 200 (3.0ms) body_len=201
2026-01-27 14:11:52 [INFO] HTTP Request: POST http://test/auth/refresh "HTTP/1.1 200 OK"
PASSED                                                                   [ 14%]
tests/auth/test_auth_refresh.py::test_refresh_token_expirado 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:52 [INFO] POST /auth/refresh 127.0.0.1 -> 401 (5.3ms) body_len=38
2026-01-27 14:11:52 [INFO] HTTP Request: POST http://test/auth/refresh "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 15%]
tests/auth/test_auth_refresh.py::test_refresh_com_access_token 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:52 [INFO] POST /auth/refresh 127.0.0.1 -> 401 (2.6ms) body_len=37
2026-01-27 14:11:52 [INFO] HTTP Request: POST http://test/auth/refresh "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 16%]
tests/auth/test_auth_refresh.py::test_refresh_token_usuario_inativo 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:52 [INFO] POST /auth/refresh 127.0.0.1 -> 403 (6.0ms) body_len=48
2026-01-27 14:11:52 [INFO] HTTP Request: POST http://test/auth/refresh "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 16%]
tests/auth/test_auth_refresh_integration.py::test_login_and_refresh PASSED [ 17%]
tests/auth/test_auth_rotas.py::test_external_login_sucesso 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [INFO] POST /auth/external-login 127.0.0.1 -> 200 (4.7ms) body_len=40
2026-01-27 14:11:53 [INFO] HTTP Request: POST http://test/auth/external-login "HTTP/1.1 200 OK"
PASSED                                                                   [ 18%]
tests/auth/test_auth_rotas.py::test_get_me_sem_token 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:11:53 [INFO] GET /auth/me 127.0.0.1 -> 401 (5.3ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 18%]
tests/auth/test_auth_rotas.py::test_get_me_com_token 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [INFO] GET /auth/me 127.0.0.1 -> 200 (3.6ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 200 OK"
PASSED                                                                   [ 19%]
tests/auth/test_auth_rotas.py::test_get_me_com_token_expirado 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [WARNING] JWT expired: Signature has expired
2026-01-27 14:11:53 [WARNING] AUTH REJECT: falha ao decodificar token: Token expirado.
2026-01-27 14:11:53 [INFO] GET /auth/me 127.0.0.1 -> 401 (7.1ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 20%]
tests/auth/test_auth_rotas.py::test_get_me_com_token_invalido 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [WARNING] JWT invalid: Signature verification failed
2026-01-27 14:11:53 [WARNING] AUTH REJECT: falha ao decodificar token: Token inv├ílido.
2026-01-27 14:11:53 [INFO] GET /auth/me 127.0.0.1 -> 401 (7.0ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 20%]
tests/auth/test_auth_rotas.py::test_get_me_com_token_role_adulterada 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [INFO] Auth token payload preview: sub=test_tampered_role_user role=admin type=access
2026-01-27 14:11:53 [WARNING] AUTH REJECT: mismatch entre role do token (admin) e role do DB (usuario_logado) para user=test_tampered_role_user
2026-01-27 14:11:53 [INFO] GET /auth/me 127.0.0.1 -> 401 (8.4ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: GET http://test/auth/me "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 21%]
tests/auth/test_auth_rotas.py::test_external_login_usuario_inativo 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [INFO] POST /auth/external-login 127.0.0.1 -> 403 (2.6ms) body_len=49
2026-01-27 14:11:53 [INFO] HTTP Request: POST http://test/auth/external-login "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 21%]
tests/auth/test_auth_rotas.py::test_external_login_sem_provider_token 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [INFO] POST /auth/external-login 127.0.0.1 -> 422 (2.5ms) body_len=2
2026-01-27 14:11:53 [INFO] HTTP Request: POST http://test/auth/external-login "HTTP/1.1 422 Unprocessable Entity"
PASSED                                                                   [ 22%]
tests/core/projections/test_progress_projector.py::test_progress_with_no_effects_all_pending PASSED [ 23%]
tests/core/projections/test_progress_projector.py::test_progress_step_completed PASSED [ 23%]
tests/core/projections/test_progress_projector.py::test_progress_step_failed_sets_error PASSED [ 24%]
tests/domain/effects/test_retry_ux_effects.py::test_retry_emits_retry_ux_effect PASSED [ 25%]
tests/domain/effects/test_retry_ux_effects.py::test_retry_executes_failed_effects FAILED [ 25%]
tests/domain/effects/test_retry_ux_effects.py::test_retry_endpoint_returns_202 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [INFO] Fetched 0 failed EffectResults for relato=relato-123
2026-01-27 14:11:53 [INFO] POST /relatos/relato-123/retry 127.0.0.1 -> 202 (194.2ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: POST http://test/relatos/relato-123/retry "HTTP/1.1 202 Accepted"
PASSED                                                                   [ 26%]
tests/domain/effects/test_retry_ux_effects.py::test_retry_endpoint_returns_ux_effect 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [INFO] Fetched 0 failed EffectResults for relato=relato-123
2026-01-27 14:11:53 [INFO] POST /relatos/relato-123/retry 127.0.0.1 -> 202 (156.8ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: POST http://test/relatos/relato-123/retry "HTTP/1.1 202 Accepted"
FAILED                                                                   [ 27%]
tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_valid_payload_passes_validation FAILED [ 27%]
tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_invalid_tag_fails PASSED [ 28%]
tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_invalid_signal_fails PASSED [ 29%]
tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_invalid_body_region_fails PASSED [ 29%]
tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_confidence_out_of_range_fails PASSED [ 30%]
tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_summary_too_long_fails PASSED [ 30%]
tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_missing_required_field_fails PASSED [ 31%]
tests/domain/relato/test_create_relato.py::test_criar_relato_estado_inicial FAILED [ 32%]
tests/domain/relato/test_create_relato.py::test_negar_criacao_relato_existente FAILED [ 32%]
tests/domain/relato/test_create_relato.py::test_post_relatos_success_runs_domain_and_executes_effects 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:54 [INFO] POST /relatos/ testclient -> 201 (12.1ms) body_len=111
2026-01-27 14:11:54 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 201 Created"
FAILED                                                                   [ 33%]
tests/domain/relato/test_create_relato.py::test_post_relatos_admin_is_allowed_by_domain 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:54 [INFO] Executando efeitos do relato | total=2
2026-01-27 14:11:54 [INFO] ADAPTER: Persistindo relato 6ca4f006e7c04ab685a220716104dd64 | owner=admin-123 status=created
2026-01-27 14:11:54 [ERROR] Erro ao persistir relato
Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\app\services\relato_effect_executor.py", line 97, in execute
    result = build_effect_result(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\services\effects\build_result.py", line 39, in build_effect_result
    return EffectResult(
           ^^^^^^^^^^^^^
TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'
2026-01-27 14:11:54 [WARNING] Falha na execu├º├úo de efeitos. Iniciando rollback compensat├│rio | total_executados=0
2026-01-27 14:11:54 [ERROR] Unhandled exception for POST /relatos/ (188.3ms): cannot access local variable 'result' where it is not associated with a value
Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 148, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\anyio\streams\memory.py", line 126, in receive
    raise EndOfStream from None
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\app\main.py", line 51, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    raise app_exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Python311\Lib\contextlib.py", line 155, in __exit__
    self.gen.throw(typ, value, traceback)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\archlog_sync\middleware.py", line 19, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    raise app_exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\routes\relatos.py", line 125, in criar_e_enviar_relato
    executor.execute(decision.effects)
  File "D:\workspace_projects_001\dermasync-api\app\services\relato_effect_executor.py", line 127, in execute
    persist_effect_result_firestore(result)
                                    ^^^^^^
UnboundLocalError: cannot access local variable 'result' where it is not associated with a value
FAILED                                                                   [ 34%]
tests/domain/relato/test_create_relato.py::test_executor_called_when_admin_creates_relato 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:56 [INFO] POST /relatos/ testclient -> 201 (7.3ms) body_len=114
2026-01-27 14:11:56 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 201 Created"
PASSED                                                                   [ 34%]
tests/domain/relato/test_create_relato.py::test_create_relato_emits_typed_effects FAILED [ 35%]
tests/domain/relato/test_create_relato.py::test_create_relato_initial_state_is_created FAILED [ 36%]
tests/domain/relato/test_create_relato_decision.py::test_create_relato_allowed_from_initial_state FAILED [ 36%]
tests/domain/relato/test_create_relato_decision.py::test_create_relato_denied_when_already_exists FAILED [ 37%]
tests/domain/relato/test_create_relato_decision.py::test_create_relato_denied_from_any_existing_state FAILED [ 38%]
tests/domain/relato/test_create_relato_decision.py::test_create_relato_effects_structure FAILED [ 38%]
tests/domain/relato/test_invalid_transitions.py::test_negar_submissao_estado_error PASSED [ 39%]
tests/domain/relato/test_invalid_transitions.py::test_negar_submissao_estado_processado PASSED [ 40%]
tests/domain/relato/test_invalid_transitions.py::test_negar_aprovacao_estado_draft FAILED [ 40%]
tests/domain/relato/test_invalid_transitions.py::test_negar_aprovacao_estado_processing PASSED [ 41%]
tests/domain/relato/test_invalid_transitions.py::test_negar_rejeicao_estado_draft FAILED [ 41%]
tests/domain/relato/test_invalid_transitions.py::test_negar_rejeicao_estado_processing PASSED [ 42%]
tests/domain/relato/test_invalid_transitions.py::test_negar_marcar_como_processado_estado_draft FAILED [ 43%]
tests/domain/relato/test_permissions.py::test_admin_pode_aprovar_relato PASSED [ 43%]
tests/domain/relato/test_permissions.py::test_colaborador_pode_aprovar_relato PASSED [ 44%]
tests/domain/relato/test_permissions.py::test_usuario_comum_nao_pode_aprovar_relato PASSED [ 45%]
tests/domain/relato/test_permissions.py::test_admin_pode_rejeitar_relato PASSED [ 45%]
tests/domain/relato/test_permissions.py::test_colaborador_pode_rejeitar_relato PASSED [ 46%]
tests/domain/relato/test_permissions.py::test_usuario_comum_nao_pode_rejeitar_relato PASSED [ 47%]
tests/domain/relato/test_permissions.py::test_admin_pode_arquivar_relato PASSED [ 47%]
tests/domain/relato/test_permissions.py::test_colaborador_pode_arquivar_relato PASSED [ 48%]
tests/domain/relato/test_permissions.py::test_usuario_comum_nao_pode_arquivar_relato PASSED [ 49%]
tests/domain/relato/test_submit_relato.py::test_submeter_relato_estado_draft FAILED [ 49%]
tests/domain/relato/test_submit_relato.py::test_negar_submissao_estado_invalido PASSED [ 50%]
tests/domain/relato/test_submit_relato.py::test_negar_submissao_estado_processado PASSED [ 50%]
tests/domain/relato/test_submit_relato.py::test_negar_submissao_estado_error PASSED [ 51%]
tests/domain/ux_effects/test_ux_effect_public_contract.py::test_ux_effect_public_contract_snapshot FAILED [ 52%]
tests/domain/ux_effects/test_ux_effects_composition.py::test_multiple_ux_effects_preserve_order_and_contract FAILED [ 52%]
tests/domain/ux_progress/test_ux_progress.py::test_progress_with_no_effects_returns_all_steps_pending PASSED [ 53%]
tests/domain/ux_progress/test_ux_progress.py::test_persist_relato_marks_first_step_done FAILED [ 54%]
tests/domain/ux_progress/test_ux_progress.py::test_upload_images_becomes_active_when_effect_exists_but_not_completed FAILED [ 54%]
tests/domain/ux_progress/test_ux_progress.py::test_upload_images_has_more_weight_in_progress FAILED [ 55%]
tests/domain/ux_progress/test_ux_progress.py::test_error_in_any_step_sets_has_error FAILED [ 56%]
tests/domain/ux_progress/test_ux_progress.py::test_all_steps_done_marks_progress_complete FAILED [ 56%]
tests/infra/retry/test_retry_repository.py::test_load_failed_effect_results_basic 
-------------------------------- live log call --------------------------------
2026-01-27 14:11:57 [ERROR] Falha ao materializar EffectResult | doc_id=<Mock name='mock.id' id='2091937412944'>
Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\app\infra\retry\retry_repository.py", line 50, in load_failed_effect_results
    result = EffectResult(
             ^^^^^^^^^^^^^
TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'
2026-01-27 14:11:57 [INFO] RetryRepository | carregados=0 | limit=10
FAILED                                                                   [ 57%]
tests/infra/retry/test_retry_scheduler.py::test_retry_scheduler_runs_and_returns_decisions FAILED [ 58%]
tests/integration/test_relato_progress_firestore.py::test_effect_result_repository_reads_from_firestore FAILED [ 58%]
tests/integration/test_relato_progress_firestore.py::test_progress_service_with_firestore_emulator PASSED [ 59%]
tests/routes/test_galeria_refactor.py::test_galeria_publica_v3_route_exists 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:07 [INFO] Obtendo o bucket de armazenamento do Firebase ... $fake-bucket.appspot.com
2026-01-27 14:12:07 [INFO] Obtendo o bucket de armazenamento do Firebase ... $fake-bucket.appspot.com
2026-01-27 14:12:07 [INFO] Obtendo o bucket de armazenamento do Firebase ... $fake-bucket.appspot.com
2026-01-27 14:12:07 [INFO] GET /galeria/public/v3 127.0.0.1 -> 200 (247.9ms) body_len=0
2026-01-27 14:12:07 [INFO] HTTP Request: GET http://test/galeria/public/v3 "HTTP/1.1 200 OK"
PASSED                                                                   [ 60%]
tests/routes/test_galeria_refactor.py::test_relatos_galeria_publica_v3_route_does_not_exist 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:08 [INFO] GET /relatos/galeria/public/v3 127.0.0.1 -> 404 (1.0ms) body_len=0
2026-01-27 14:12:08 [INFO] HTTP Request: GET http://test/relatos/galeria/public/v3 "HTTP/1.1 404 Not Found"
PASSED                                                                   [ 60%]
tests/routes/test_relatos_multipart.py::test_post_relatos_with_real_multipart_upload 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:08 [INFO] POST /relatos/ testclient -> 201 (14.7ms) body_len=363
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 201 Created"
FAILED                                                                   [ 61%]
tests/routes/test_relatos_multipart.py::test_upload_failure_triggers_rollback FAILED [ 61%]
tests/routes/test_relatos_multipart.py::test_effect_result_persist_and_fetch_success FAILED [ 62%]
tests/routes/test_relatos_post.py::test_post_relatos_success FAILED      [ 63%]
tests/routes/test_relatos_post.py::test_post_relatos_denied_by_domain FAILED [ 63%]
tests/routes/test_relatos_post.py::test_post_relatos_missing_consentimento 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:08 [INFO] POST /relatos testclient -> 307 (1.0ms) body_len=169
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos "HTTP/1.1 307 Temporary Redirect"
2026-01-27 14:12:08 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:12:08 [INFO] POST /relatos/ testclient -> 401 (6.9ms) body_len=169
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 401 Unauthorized"
FAILED                                                                   [ 64%]
tests/routes/test_relatos_post.py::test_post_relatos_no_consentimento_field 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:08 [INFO] POST /relatos testclient -> 307 (2.0ms) body_len=137
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos "HTTP/1.1 307 Temporary Redirect"
2026-01-27 14:12:08 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:12:08 [INFO] POST /relatos/ testclient -> 401 (7.7ms) body_len=137
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 401 Unauthorized"
FAILED                                                                   [ 65%]
tests/routes/test_relatos_post.py::test_post_relatos_executor_not_called_when_denied FAILED [ 65%]
tests/routes/test_relatos_progress.py::test_get_relato_progress_unauthenticated 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:08 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:12:08 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 401 (8.1ms) body_len=0
2026-01-27 14:12:08 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 66%]
tests/routes/test_relatos_progress.py::test_get_relato_progress_forbidden 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:13 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4814.8ms) body_len=0
2026-01-27 14:12:13 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
FAILED                                                                   [ 67%]
tests/routes/test_relatos_progress.py::test_get_relato_progress_empty 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:18 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4830.0ms) body_len=0
2026-01-27 14:12:18 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
FAILED                                                                   [ 67%]
tests/routes/test_relatos_progress.py::test_get_relato_progress_partial_with_error 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:23 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4673.7ms) body_len=0
2026-01-27 14:12:23 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
FAILED                                                                   [ 68%]
tests/routes/test_relatos_progress.py::test_get_relato_progress_complete 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:28 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4772.1ms) body_len=0
2026-01-27 14:12:28 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
FAILED                                                                   [ 69%]
tests/services/effects/test_persist_effect_result_firestore.py::test_persist_effect_result_firestore_accepts_uuid_fields FAILED [ 69%]
tests/services/effects/test_persist_effect_result_firestore.py::test_persist_effect_result_firestore_rejects_raw_uuid_values FAILED [ 70%]
tests/services/effects/test_persist_effect_result_firestore.py::test_persist_effect_result_firestore_normalizes_uuid_before_persisting FAILED [ 70%]
tests/services/effects/test_registry_real_effects.py::test_all_effects_registered PASSED [ 71%]
tests/services/effects/test_retry_classifier.py::test_classify_timeout FAILED [ 72%]
tests/services/effects/test_retry_classifier.py::test_classify_invalid_input FAILED [ 72%]
tests/services/effects/test_retry_classifier.py::test_classify_unknown FAILED [ 73%]
tests/services/effects/test_retry_effect.py::test_retry_effect_success FAILED [ 74%]
tests/services/effects/test_retry_effect_unsupported.py::test_retry_effect_unsupported_type_raises FAILED [ 74%]
tests/services/effects/test_retry_executor.py::test_retry_persist_relato FAILED [ 75%]
tests/services/effects/test_retry_executor.py::test_retry_enqueue_processing FAILED [ 76%]
tests/services/effects/test_retry_executor.py::test_retry_emit_event FAILED [ 76%]
tests/services/effects/test_retry_executor.py::test_retry_upload_images_success FAILED [ 77%]
tests/services/effects/test_retry_executor.py::test_retry_upload_images_without_metadata_fails FAILED [ 78%]
tests/services/effects/test_retry_executor.py::test_retry_unknown_effect_type_fails FAILED [ 78%]
tests/services/effects/test_retry_policy_contract.py::test_retry_policy_contract FAILED [ 79%]
tests/services/effects/test_retry_policy_decision.py::test_network_error_retries PASSED [ 80%]
tests/services/effects/test_retry_policy_decision.py::test_invalid_input_never_retries PASSED [ 80%]
tests/services/effects/test_retry_policy_decision.py::test_unknown_allows_single_retry PASSED [ 81%]
tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_empty FAILED [ 81%]
tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_partial_with_error FAILED [ 82%]
tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_in_progress FAILED [ 83%]
tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_completed FAILED [ 83%]
tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_with_missing_fields PASSED [ 84%]
tests/services/test_executor_idempotency.py::test_executor_skips_effect_if_already_succeeded FAILED [ 85%]
tests/services/test_ux_effects.py::test_ux_effect_contract_shape FAILED  [ 85%]
tests/services/test_ux_effects.py::test_processing_started_ux_effect_contract FAILED [ 86%]
tests/test_archlog_sync_extra.py::test_parse_logs_file_not_found 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:28 [INFO] Parsing logs from: app/archlog_sync/exemplos/nao_existe.jsonl
2026-01-27 14:12:28 [ERROR] Log file not found: app/archlog_sync/exemplos/nao_existe.jsonl
PASSED                                                                   [ 87%]
tests/test_archlog_sync_extra.py::test_parse_logs_empty 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:28 [INFO] Criando arquivo vazio para teste: C:\Users\Jefferson\AppData\Local\Temp\pytest-of-Jefferson\pytest-9\test_parse_logs_empty0\empty.jsonl
2026-01-27 14:12:28 [INFO] Parsing logs from: C:\Users\Jefferson\AppData\Local\Temp\pytest-of-Jefferson\pytest-9\test_parse_logs_empty0\empty.jsonl
PASSED                                                                   [ 87%]
tests/test_archlog_sync_extra.py::test_mermaid_empty 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:28 [INFO] Gerando diagrama de sequ├¬ncia Mermaid a partir dos eventos de log
2026-01-27 14:12:28 [INFO] Total de eventos recebidos: 0
2026-01-27 14:12:28 [WARNING] Nenhum evento fornecido, retornando diagrama vazio
PASSED                                                                   [ 88%]
tests/test_archlog_sync_extra.py::test_mermaid_order 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:28 [INFO] Testando ordem de eventos no diagrama Mermaid
2026-01-27 14:12:28 [INFO] Total de eventos no sample: 4
2026-01-27 14:12:28 [INFO] Tipo da vari├ível sample_events: <class 'list'>
2026-01-27 14:12:28 [INFO] Gerando diagrama de sequ├¬ncia Mermaid a partir dos eventos de log
2026-01-27 14:12:28 [INFO] Total de eventos recebidos: 4
PASSED                                                                   [ 89%]
tests/test_archlog_sync_extra.py::test_detect_slow_calls_edge PASSED     [ 89%]
tests/test_archlog_sync_extra.py::test_compute_avg_latency_simple PASSED [ 90%]
tests/test_healthcheck.py::test_healthz_success 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:29 [INFO] GET /healthz 127.0.0.1 -> 200 (4.5ms) body_len=0
2026-01-27 14:12:29 [INFO] HTTP Request: GET http://test/healthz "HTTP/1.1 200 OK"
PASSED                                                                   [ 90%]
tests/test_healthcheck.py::test_healthz_failure_firebase 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:29 [INFO] GET /healthz 127.0.0.1 -> 503 (3.0ms) body_len=0
2026-01-27 14:12:29 [INFO] HTTP Request: GET http://test/healthz "HTTP/1.1 503 Service Unavailable"
PASSED                                                                   [ 91%]
tests/test_healthcheck.py::test_healthz_failure_chromadb 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:29 [INFO] GET /healthz 127.0.0.1 -> 503 (4.0ms) body_len=0
2026-01-27 14:12:29 [INFO] HTTP Request: GET http://test/healthz "HTTP/1.1 503 Service Unavailable"
PASSED                                                                   [ 92%]
tests/test_imagens_avancado.py::test_upload_imagem_tipo_invalido 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:29 [INFO] Upload de imagem solicitado por user_123: invalid_file.txt
2026-01-27 14:12:29 [INFO] POST /imagens/upload 127.0.0.1 -> 415 (12.3ms) body_len=198
2026-01-27 14:12:29 [INFO] HTTP Request: POST http://test/imagens/upload "HTTP/1.1 415 Unsupported Media Type"
PASSED                                                                   [ 92%]
tests/test_imagens_avancado.py::test_upload_imagem_valido 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:29 [INFO] Upload de imagem solicitado por user_123: valid_image.jpeg
2026-01-27 14:12:29 [INFO] POST /imagens/upload 127.0.0.1 -> 200 (8.6ms) body_len=811
2026-01-27 14:12:29 [INFO] HTTP Request: POST http://test/imagens/upload "HTTP/1.1 200 OK"
PASSED                                                                   [ 93%]
tests/test_parser_metrics.py::test_parse_logs_groups 
------------------------------- live log setup --------------------------------
2026-01-27 14:12:29 [INFO] Parsing logs from: app/archlog_sync/exemplos/relato_log.jsonl
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:01Z', 'request_id': 'req_001', 'caller': 'frontend', 'callee': 'relato_service', 'operation': 'POST /enviar-relato', 'status_code': 200, 'duration_ms': 122}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:02Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'firebase_storage', 'operation': 'upload_imagem', 'status_code': 200, 'duration_ms': 321}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:03Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'llm_extractor', 'operation': 'extrair_tags', 'status_code': 200, 'duration_ms': 1522}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:04Z', 'request_id': 'req_001', 'caller': 'llm_extractor', 'callee': 'chromadb', 'operation': 'persistir_vetor', 'status_code': 200, 'duration_ms': 88}
2026-01-27 14:12:29 [INFO] Loaded groups: {"req_001": [{"timestamp": "2025-07-04T14:00:01Z", "request_id": "req_001", "caller": "frontend", "callee": "relato_service", "operation": "POST /enviar-relato", "status_code": 200, "duration_ms": 122}, {"timestamp": "2025-07-04T14:00:02Z", "request_id": "req_001", "caller": "relato_service", "callee": "firebase_storage", "operation": "upload_imagem", "status_code": 200, "duration_ms": 321}, {"timestamp": "2025-07-04T14:00:03Z", "request_id": "req_001", "caller": "relato_service", "callee": "llm_extractor", "operation": "extrair_tags", "status_code": 200, "duration_ms": 1522}, {"timestamp": "2025-07-04T14:00:04Z", "request_id": "req_001", "caller": "llm_extractor", "callee": "chromadb", "operation": "persistir_vetor", "status_code": 200, "duration_ms": 88}]}
PASSED                                                                   [ 94%]
tests/test_parser_metrics.py::test_mermaid_generator 
------------------------------- live log setup --------------------------------
2026-01-27 14:12:29 [INFO] Parsing logs from: app/archlog_sync/exemplos/relato_log.jsonl
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:01Z', 'request_id': 'req_001', 'caller': 'frontend', 'callee': 'relato_service', 'operation': 'POST /enviar-relato', 'status_code': 200, 'duration_ms': 122}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:02Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'firebase_storage', 'operation': 'upload_imagem', 'status_code': 200, 'duration_ms': 321}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:03Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'llm_extractor', 'operation': 'extrair_tags', 'status_code': 200, 'duration_ms': 1522}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:04Z', 'request_id': 'req_001', 'caller': 'llm_extractor', 'callee': 'chromadb', 'operation': 'persistir_vetor', 'status_code': 200, 'duration_ms': 88}
2026-01-27 14:12:29 [INFO] Loaded groups: {"req_001": [{"timestamp": "2025-07-04T14:00:01Z", "request_id": "req_001", "caller": "frontend", "callee": "relato_service", "operation": "POST /enviar-relato", "status_code": 200, "duration_ms": 122}, {"timestamp": "2025-07-04T14:00:02Z", "request_id": "req_001", "caller": "relato_service", "callee": "firebase_storage", "operation": "upload_imagem", "status_code": 200, "duration_ms": 321}, {"timestamp": "2025-07-04T14:00:03Z", "request_id": "req_001", "caller": "relato_service", "callee": "llm_extractor", "operation": "extrair_tags", "status_code": 200, "duration_ms": 1522}, {"timestamp": "2025-07-04T14:00:04Z", "request_id": "req_001", "caller": "llm_extractor", "callee": "chromadb", "operation": "persistir_vetor", "status_code": 200, "duration_ms": 88}]}
-------------------------------- live log call --------------------------------
2026-01-27 14:12:29 [INFO] Gerando diagrama de sequ├¬ncia Mermaid a partir dos eventos de log
2026-01-27 14:12:29 [INFO] Total de eventos recebidos: 4
PASSED                                                                   [ 94%]
tests/test_parser_metrics.py::test_compute_avg_latency 
------------------------------- live log setup --------------------------------
2026-01-27 14:12:29 [INFO] Parsing logs from: app/archlog_sync/exemplos/relato_log.jsonl
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:01Z', 'request_id': 'req_001', 'caller': 'frontend', 'callee': 'relato_service', 'operation': 'POST /enviar-relato', 'status_code': 200, 'duration_ms': 122}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:02Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'firebase_storage', 'operation': 'upload_imagem', 'status_code': 200, 'duration_ms': 321}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:03Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'llm_extractor', 'operation': 'extrair_tags', 'status_code': 200, 'duration_ms': 1522}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:04Z', 'request_id': 'req_001', 'caller': 'llm_extractor', 'callee': 'chromadb', 'operation': 'persistir_vetor', 'status_code': 200, 'duration_ms': 88}
2026-01-27 14:12:29 [INFO] Loaded groups: {"req_001": [{"timestamp": "2025-07-04T14:00:01Z", "request_id": "req_001", "caller": "frontend", "callee": "relato_service", "operation": "POST /enviar-relato", "status_code": 200, "duration_ms": 122}, {"timestamp": "2025-07-04T14:00:02Z", "request_id": "req_001", "caller": "relato_service", "callee": "firebase_storage", "operation": "upload_imagem", "status_code": 200, "duration_ms": 321}, {"timestamp": "2025-07-04T14:00:03Z", "request_id": "req_001", "caller": "relato_service", "callee": "llm_extractor", "operation": "extrair_tags", "status_code": 200, "duration_ms": 1522}, {"timestamp": "2025-07-04T14:00:04Z", "request_id": "req_001", "caller": "llm_extractor", "callee": "chromadb", "operation": "persistir_vetor", "status_code": 200, "duration_ms": 88}]}
PASSED                                                                   [ 95%]
tests/test_parser_metrics.py::test_detect_slow_calls 
------------------------------- live log setup --------------------------------
2026-01-27 14:12:29 [INFO] Parsing logs from: app/archlog_sync/exemplos/relato_log.jsonl
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:01Z', 'request_id': 'req_001', 'caller': 'frontend', 'callee': 'relato_service', 'operation': 'POST /enviar-relato', 'status_code': 200, 'duration_ms': 122}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:02Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'firebase_storage', 'operation': 'upload_imagem', 'status_code': 200, 'duration_ms': 321}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:03Z', 'request_id': 'req_001', 'caller': 'relato_service', 'callee': 'llm_extractor', 'operation': 'extrair_tags', 'status_code': 200, 'duration_ms': 1522}
2026-01-27 14:12:29 [INFO] Processing entry: {'timestamp': '2025-07-04T14:00:04Z', 'request_id': 'req_001', 'caller': 'llm_extractor', 'callee': 'chromadb', 'operation': 'persistir_vetor', 'status_code': 200, 'duration_ms': 88}
2026-01-27 14:12:29 [INFO] Loaded groups: {"req_001": [{"timestamp": "2025-07-04T14:00:01Z", "request_id": "req_001", "caller": "frontend", "callee": "relato_service", "operation": "POST /enviar-relato", "status_code": 200, "duration_ms": 122}, {"timestamp": "2025-07-04T14:00:02Z", "request_id": "req_001", "caller": "relato_service", "callee": "firebase_storage", "operation": "upload_imagem", "status_code": 200, "duration_ms": 321}, {"timestamp": "2025-07-04T14:00:03Z", "request_id": "req_001", "caller": "relato_service", "callee": "llm_extractor", "operation": "extrair_tags", "status_code": 200, "duration_ms": 1522}, {"timestamp": "2025-07-04T14:00:04Z", "request_id": "req_001", "caller": "llm_extractor", "callee": "chromadb", "operation": "persistir_vetor", "status_code": 200, "duration_ms": 88}]}
PASSED                                                                   [ 96%]
tests/test_pipeline_01_jsonlbruto.py::test_gerar_jsonl_bruto_formato_valido 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:29 [INFO] Iniciando a gera├º├úo do JSONL bruto...
2026-01-27 14:12:29 [INFO] Par├ómetros de entrada: {'origem': 'facebook', 'src_dir': 'C:\\Users\\JEFFER~1\\AppData\\Local\\Temp\\tmp_5tmog6x', 'ctx_id': '1234567890', 'grupo': 'Dermatite At├│pica Brasil', 'tipo': 'comentario'}, C:\Users\JEFFER~1\AppData\Local\Temp\tmp_5tmog6x\saida.jsonl
2026-01-27 14:12:29 [INFO] Dado gerado: {'id_relato': '852d9ace8d76447184f237207f3ba476', 'origem': {'plataforma': 'facebook', 'link': None, 'tipo': 'comentario', 'ano_postagem': None, 'grupo': 'Dermatite At├│pica Brasil', 'ctx_id': '1234567890'}, 'versao_pipeline': 'v0.0.1', 'data_modificacao': '2026-01-27T14:12:29.301176', 'conteudo_original': 'Relato de teste sobre coceira e pele seca.'}
PASSED                                                                   [ 96%]
tests/test_pipeline_01_jsonlbruto.py::test_valida_schema_jsonl_bruto PASSED [ 97%]
tests/test_pipeline_02_enriquecer_metadados.py::test_enriquecer_metadados_formato_valido 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:32 [INFO] Usando cliente LLM: <app.pipeline.llm_client.gemini_client.GeminiClient object at 0x000001E711567790>
2026-01-27 14:12:32 [INFO] Enviando prompt para LLM...
2026-01-27 14:12:32 [ERROR] Erro ao processar relato: 404 models/gemini is not found for API version v1beta, or is not supported for generateContent. Call ListModels to see the list of available models and their supported methods.
XFAIL (pipeline n├úo estabilizado)                                        [ 98%]
tests/test_pipeline_02_enriquecer_metadados.py::test_if_jsonl_linha_valido PASSED [ 98%]
tests/test_pipeline_integracao_01_02.py::test_integracao_fase_01_e_02 
-------------------------------- live log call --------------------------------
2026-01-27 14:12:32 [INFO] Iniciando a gera├º├úo do JSONL bruto...
2026-01-27 14:12:32 [INFO] Par├ómetros de entrada: {'origem': 'facebook', 'src_dir': 'C:\\Users\\JEFFER~1\\AppData\\Local\\Temp\\tmp__hxtqj2', 'ctx_id': 'CTX1234567890', 'grupo': 'Grupo de Teste', 'tipo': 'comentario'}, C:\Users\JEFFER~1\AppData\Local\Temp\tmp__hxtqj2\saida.jsonl
2026-01-27 14:12:32 [INFO] Usando cliente LLM: <app.pipeline.llm_client.gemini_client.GeminiClient object at 0x000001E721C03D90>
2026-01-27 14:12:32 [INFO] Enviando prompt para LLM...
2026-01-27 14:12:33 [ERROR] Erro ao processar relato: 404 models/gemini is not found for API version v1beta, or is not supported for generateContent. Call ListModels to see the list of available models and their supported methods.
XFAIL (pipeline n├úo estabilizado)                                        [ 99%]
tests/ux/test_cognitive_integration_flow.py::test_user_sees_coherent_story_from_ux_effects FAILED [100%]

================================== FAILURES ===================================
_____________ test_job_persists_snapshot_when_progress_is_stable ______________

    def test_job_persists_snapshot_when_progress_is_stable():
        snapshot_repo = Mock()
        effect_repo = Mock()
    
        snapshot_repo.get_by_relato_id.return_value = None
    
        effect_repo.fetch_by_relato_id.return_value = [
>           EffectResult(
                type="PERSIST_RELATO",
                success=True,
                executed_at=datetime.utcnow(),
            ),
            EffectResult(
                type="UPLOAD_IMAGES",
                success=True,
                executed_at=datetime.utcnow(),
            ),
            EffectResult(
                type="ENRICH_METADATA",
                success=True,
                executed_at=datetime.utcnow(),
            ),
        ]
E       TypeError: EffectResult.__init__() missing 2 required positional arguments: 'error_message' and 'metadata'

tests\application\test_relato_progress_stabilization_service.py:35: TypeError
_____________________ test_retry_executes_failed_effects ______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001E71137D2D0>

    def test_retry_executes_failed_effects(monkeypatch):
        executed = []
    
>       fake_result = EffectResult(
            relato_id="relato-123",
            effect_type="UPLOAD_IMAGES",
            effect_ref="relato-123",
            success=False,
            metadata=None,
            error="fail",
            created_at=datetime.now(timezone.utc),
            executed_at=None,
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\domain\effects\test_retry_ux_effects.py:41: TypeError
____________________ test_retry_endpoint_returns_ux_effect ____________________

client = <httpx.AsyncClient object at 0x000001E711337FD0>

    @pytest.mark.asyncio
    async def test_retry_endpoint_returns_ux_effect(client):
        response = await client.post("/relatos/relato-123/retry")
        body = response.json()
    
        assert "ux_effects" in body
>       assert body["ux_effects"][0]["type"] == "RetryUXEffect"
               ^^^^^^^^^^^^^^^^^^^^^
E       IndexError: list index out of range

tests\domain\effects\test_retry_ux_effects.py:92: IndexError
---------------------------- Captured stdout setup ----------------------------
{"timestamp": "2026-01-27 14:11:53,700", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:11:53,861", "level": "ERROR", "logger": "app.services.effects.fetch_firestore", "message": "EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'error': \"'str' object has no attribute 'value'\", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'"}
{"timestamp": "2026-01-27 14:11:53,865", "level": "ERROR", "logger": "app.services.effects.fetch_firestore", "message": "EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'error': \"'str' object has no attribute 'value'\", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'"}
{"timestamp": "2026-01-27 14:11:53,868", "level": "ERROR", "logger": "app.services.effects.fetch_firestore", "message": "EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'error': \"'str' object has no attribute 'value'\", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'"}
{"timestamp": "2026-01-27 14:11:53,871", "level": "ERROR", "logger": "app.services.effects.fetch_firestore", "message": "EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'error': \"'str' object has no attribute 'value'\", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'"}
{"timestamp": "2026-01-27 14:11:53,874", "level": "ERROR", "logger": "app.services.effects.fetch_firestore", "message": "EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'error': \"'str' object has no attribute 'value'\", 'executed_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'"}
{"timestamp": "2026-01-27 14:11:53,878", "level": "ERROR", "logger": "app.services.effects.fetch_firestore", "message": "EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'error': \"'str' object has no attribute 'value'\", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'"}
{"timestamp": "2026-01-27 14:11:53,879", "level": "INFO", "logger": "app.services.effects.fetch_firestore", "message": "Fetched 0 failed EffectResults for relato=relato-123"}
{"timestamp": "2026-01-27 14:11:53,880", "level": "DEBUG", "logger": "app.services.ux_adapters", "message": "Ignoring non-UX domain effect: RetryUXEffect"}
{"timestamp": "2026-01-27 14:11:53,882", "level": "INFO", "logger": "root", "message": "POST /relatos/relato-123/retry 127.0.0.1 -> 202 (156.8ms) body_len=0"}
{"timestamp": "2026-01-27 14:11:53,885", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/relatos/relato-123/retry \"HTTP/1.1 202 Accepted\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:11:53] [INFO] [request_logger] POST /relatos/relato-123/retry Status: 202 Tempo: 155.84ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 27, 13, 490286, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 25, 27, 270779, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 28, 51, 397337, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 26, 24, 289944, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 12, 15, 5, 32, 809060, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [ERROR] EffectResult inv├ílido no Firestore | data={'success': False, 'relato_id': 'relato-123', 'effect_type': 'PERSIST_RELATO', 'metadata': None, 'created_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'error': "'str' object has no attribute 'value'", 'executed_at': DatetimeWithNanoseconds(2026, 1, 11, 14, 29, 53, 524593, tzinfo=datetime.timezone.utc), 'effect_ref': 'relato-123'} | erro=EffectResult.__init__() got an unexpected keyword argument 'success'
2026-01-27 14:11:53 [INFO] Fetched 0 failed EffectResults for relato=relato-123
2026-01-27 14:11:53 [INFO] POST /relatos/relato-123/retry 127.0.0.1 -> 202 (156.8ms) body_len=0
2026-01-27 14:11:53 [INFO] HTTP Request: POST http://test/relatos/relato-123/retry "HTTP/1.1 202 Accepted"
____________________ test_valid_payload_passes_validation _____________________

    def test_valid_payload_passes_validation():
        model = EnrichedMetadataV2.model_validate(VALID_PAYLOAD)
        assert model.version == "v2"
>       assert model.confidence.extraction == 0.85
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'dict' object has no attribute 'extraction'

tests\domain\enrichment\test_enriched_metadata_v2_validator.py:39: AttributeError
______________________ test_criar_relato_estado_inicial _______________________

    def test_criar_relato_estado_inicial():
        """Testa a cria├º├úo de um relato quando n├úo existe estado anterior."""
        actor = Actor(id="user-123", role=ActorRole.USER)
>       command = CreateRelato(
            relato_id="relato-456",
            owner_id="user-123",
            conteudo="Relato de teste",
            imagens={"antes": [], "durante": [], "depois": []}
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato.py:19: TypeError
_____________________ test_negar_criacao_relato_existente _____________________

    def test_negar_criacao_relato_existente():
        """Testa que n├úo ├® poss├¡vel criar um relato se ele j├í existe (estado n├úo ├® None)."""
        actor = Actor(id="user-123", role=ActorRole.USER)
>       command = CreateRelato(
            relato_id="relato-456",
            owner_id="user-123",
            conteudo="Relato de teste",
            imagens={"antes": [], "durante": [], "depois": []}
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato.py:38: TypeError
_________ test_post_relatos_success_runs_domain_and_executes_effects __________

    def test_post_relatos_success_runs_domain_and_executes_effects():
        from app.main import app
        from app.auth.schemas import User
        from app.auth.dependencies import get_current_user
        from fastapi.testclient import TestClient
        from unittest.mock import MagicMock, patch
        import json
    
        mock_user = User(
            id="user-123",
            email="test@example.com",
            role="usuario_logado"
        )
    
        # ­ƒöæ override correto do Depends
        app.dependency_overrides[get_current_user] = lambda: mock_user
    
        client = TestClient(app)
    
        # Ô£à payload MINIMAMENTE v├ílido segundo RelatoDraftInput
        payload = {
            "descricao": "Relato v├ílido",
            "consentimento": True,
            "idade": 35
        }
    
        try:
            with patch(
                "app.routes.relatos.RelatoEffectExecutor"
            ) as mock_executor_class:
                mock_executor_instance = MagicMock()
                mock_executor_class.return_value = mock_executor_instance
    
                response = client.post(
                    "/relatos/",
                    data={"payload": json.dumps(payload)}
                )
    
                assert response.status_code == 201
    
                body = response.json()
>               assert "relato_id" in body
E               AssertionError: assert 'relato_id' in {'data': {'relato_id': '626280530c104c8ab95878c606a6e3d9', 'status': 'created'}, 'ux_effects': [{'channel': 'progress', 'message': 'Relato recebido e salvo.', 'relato_id': '626280530c104c8ab95878c606a6e3d9', 'severity': 'info', ...}, {'channel': 'progress', 'message': 'Imagens enviadas para processamento.', 'relato_id': '626280530c104c8ab95878c606a6e3d9', 'severity': 'info', ...}]}

tests\domain\relato\test_create_relato.py:95: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:11:54,085", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
{"timestamp": "2026-01-27 14:11:54,109", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_start with no data"}
{"timestamp": "2026-01-27 14:11:54,110", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_name with data[0:7]"}
{"timestamp": "2026-01-27 14:11:54,110", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_data with data[8:111]"}
{"timestamp": "2026-01-27 14:11:54,110", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_end with no data"}
{"timestamp": "2026-01-27 14:11:54,110", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_end with no data"}
{"timestamp": "2026-01-27 14:11:54,117", "level": "INFO", "logger": "root", "message": "POST /relatos/ testclient -> 201 (12.1ms) body_len=111"}
{"timestamp": "2026-01-27 14:11:54,122", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/relatos/ \"HTTP/1.1 201 Created\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:11:54] [INFO] [request_logger] POST /relatos/ Status: 201 Tempo: 10.58ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:11:54 [INFO] POST /relatos/ testclient -> 201 (12.1ms) body_len=111
2026-01-27 14:11:54 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 201 Created"
________________ test_post_relatos_admin_is_allowed_by_domain _________________
  + Exception Group Traceback (most recent call last):
  |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "d:\workspace_projects_001\dermasync-api\tests\domain\relato\test_create_relato.py", line 130, in test_post_relatos_admin_is_allowed_by_domain
    |     response = client.post(
    |                ^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 531, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 430, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 339, in handle_request
    |     raise exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 336, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\errors.py", line 187, in __call__
    |     raise exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Python311\Lib\contextlib.py", line 155, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\app\main.py", line 51, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    |     raise app_exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Python311\Lib\contextlib.py", line 155, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\app\archlog_sync\middleware.py", line 19, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    |     raise app_exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\workspace_projects_001\dermasync-api\app\routes\relatos.py", line 125, in criar_e_enviar_relato
    |     executor.execute(decision.effects)
    |   File "D:\workspace_projects_001\dermasync-api\app\services\relato_effect_executor.py", line 127, in execute
    |     persist_effect_result_firestore(result)
    |                                     ^^^^^^
    | UnboundLocalError: cannot access local variable 'result' where it is not associated with a value
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "d:\workspace_projects_001\dermasync-api\tests\domain\relato\test_create_relato.py", line 130, in test_post_relatos_admin_is_allowed_by_domain
    response = client.post(
               ^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 531, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 430, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 339, in handle_request
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\testclient.py", line 336, in handle_request
    portal.call(self.app, scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\errors.py", line 187, in __call__
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Python311\Lib\contextlib.py", line 155, in __exit__
    self.gen.throw(typ, value, traceback)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\main.py", line 51, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    raise app_exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Python311\Lib\contextlib.py", line 155, in __exit__
    self.gen.throw(typ, value, traceback)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\archlog_sync\middleware.py", line 19, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    raise app_exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\routes\relatos.py", line 125, in criar_e_enviar_relato
    executor.execute(decision.effects)
  File "D:\workspace_projects_001\dermasync-api\app\services\relato_effect_executor.py", line 127, in execute
    persist_effect_result_firestore(result)
                                    ^^^^^^
UnboundLocalError: cannot access local variable 'result' where it is not associated with a value

During handling of the above exception, another exception occurred:

    def test_post_relatos_admin_is_allowed_by_domain():
        from app.main import app
        from app.auth.schemas import User
        from app.auth.dependencies import get_current_user
        from fastapi.testclient import TestClient
        import json
    
        mock_user = User(
            id="admin-123",
            email="admin@example.com",
            role="admin"
        )
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        client = TestClient(app)
    
        payload = {
            "descricao": "Relato criado por admin",
            "consentimento": True,
            "idade": 40
        }
    
        try:
>           response = client.post(
                "/relatos/",
                data={"payload": json.dumps(payload)}
            )

tests\domain\relato\test_create_relato.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
venv\Lib\site-packages\starlette\testclient.py:531: in post
    return super().post(
venv\Lib\site-packages\httpx\_client.py:1144: in post
    return self.request(
venv\Lib\site-packages\starlette\testclient.py:430: in request
    return super().request(
venv\Lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
venv\Lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv\Lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\testclient.py:339: in handle_request
    raise exc
venv\Lib\site-packages\starlette\testclient.py:336: in handle_request
    portal.call(self.app, scope, receive, send)
venv\Lib\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
venv\Lib\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv\Lib\site-packages\starlette\applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\errors.py:187: in __call__
    raise exc
venv\Lib\site-packages\starlette\middleware\errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv\Lib\site-packages\starlette\middleware\base.py:177: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Python311\Lib\contextlib.py:155: in __exit__
    self.gen.throw(typ, value, traceback)
venv\Lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
venv\Lib\site-packages\starlette\middleware\base.py:179: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\main.py:51: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\middleware\base.py:154: in call_next
    raise app_exc
venv\Lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv\Lib\site-packages\starlette\middleware\base.py:177: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Python311\Lib\contextlib.py:155: in __exit__
    self.gen.throw(typ, value, traceback)
venv\Lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
venv\Lib\site-packages\starlette\middleware\base.py:179: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\archlog_sync\middleware.py:19: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\middleware\base.py:154: in call_next
    raise app_exc
venv\Lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\starlette\routing.py:715: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:735: in app
    await route.handle(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:288: in handle
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\starlette\routing.py:73: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fastapi\routing.py:301: in app
    raw_response = await run_endpoint_function(
venv\Lib\site-packages\fastapi\routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\routes\relatos.py:125: in criar_e_enviar_relato
    executor.execute(decision.effects)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.services.relato_effect_executor.RelatoEffectExecutor object at 0x000001E711322990>
effects = [PersistRelatoEffect(relato_id='6ca4f006e7c04ab685a220716104dd64', owner_id='admin-123', status=<RelatoStatus.CREATED:...ploadImagesEffect(relato_id='6ca4f006e7c04ab685a220716104dd64', image_refs={'antes': [], 'durante': [], 'depois': []})]

    def execute(self, effects: list):
        logger.info("Executando efeitos do relato | total=%d", len(effects))
    
        executed_effects: list = []
    
        try:
            for effect in effects:
                # =====================================================
                # Idempot├¬ncia ÔÇö skip se j├í executado com sucesso
                # =====================================================
                effect_type = effect.__class__.__name__
    
                if isinstance(effect, UpdateRelatoStatusEffect):
                    effect_ref = effect.new_status.value
                elif isinstance(effect, EmitDomainEventEffect):
                    effect_ref = effect.event_name
                else:
                    effect_ref = effect.relato_id
    
                if effect_ref and effect_already_succeeded(
                    relato_id=effect.relato_id,
                    effect_type=effect_type,
                    effect_ref=effect_ref,
                ):
                    logger.info(
                        "Effect j├í executado com sucesso | skip | type=%s relato=%s ref=%s",
                        effect_type,
                        effect.relato_id,
                        effect_ref,
                    )
                    continue
    
    
    
                # =====================================================
                # PersistRelatoEffect
                # =====================================================
                if isinstance(effect, PersistRelatoEffect):
                    try:
                        self._persist_relato(
                            relato_id=effect.relato_id,
                            owner_id=effect.owner_id,
                            status=effect.status.value,
                            conteudo=effect.conteudo,
                            images_refs=effect.image_refs, # apenas refs
                        )
    
                        result = build_effect_result(
                            relato_id=effect.relato_id,
                            effect_type="PERSIST_RELATO",
                            effect_ref=effect.relato_id,
                            success=True,
                            metadata={
                                "status": effect.status.value,
                                "effect_data": {
                                    "owner_id": str(effect.owner_id),
                                    "status": effect.status.value,
                                    "conteudo": effect.conteudo,
                                },
                            },
                            error=None,
                        )
    
                    except Exception as exc:
                        logger.exception("Erro ao persistir relato")
    
                        result = build_effect_result(
                            relato_id=effect.relato_id,
                            effect_type="PERSIST_RELATO",
                            effect_ref=effect.relato_id,
                            success=False,
                            error=str(exc),
                            metadata=None,
                        )
                        raise
    
                    finally:
>                       persist_effect_result_firestore(result)
                                                        ^^^^^^
E                       UnboundLocalError: cannot access local variable 'result' where it is not associated with a value

app\services\relato_effect_executor.py:127: UnboundLocalError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:11:54,193", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
{"timestamp": "2026-01-27 14:11:54,216", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_start with no data"}
{"timestamp": "2026-01-27 14:11:54,216", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_name with data[0:7]"}
{"timestamp": "2026-01-27 14:11:54,217", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_data with data[8:114]"}
{"timestamp": "2026-01-27 14:11:54,217", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_end with no data"}
{"timestamp": "2026-01-27 14:11:54,218", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_end with no data"}
{"timestamp": "2026-01-27 14:11:54,221", "level": "INFO", "logger": "app.services.relato_effect_executor", "message": "Executando efeitos do relato | total=2"}
{"timestamp": "2026-01-27 14:11:54,299", "level": "INFO", "logger": "app.services.relato_adapters", "message": "ADAPTER: Persistindo relato 6ca4f006e7c04ab685a220716104dd64 | owner=admin-123 status=created"}
{"timestamp": "2026-01-27 14:11:54,394", "level": "ERROR", "logger": "app.services.relato_effect_executor", "message": "Erro ao persistir relato"}
{"timestamp": "2026-01-27 14:11:54,399", "level": "WARNING", "logger": "app.services.relato_effect_executor", "message": "Falha na execu├º├úo de efeitos. Iniciando rollback compensat├│rio | total_executados=0"}
{"timestamp": "2026-01-27 14:11:54,401", "level": "ERROR", "logger": "root", "message": "Unhandled exception for POST /relatos/ (188.3ms): cannot access local variable 'result' where it is not associated with a value"}
------------------------------ Captured log call ------------------------------
2026-01-27 14:11:54 [INFO] Executando efeitos do relato | total=2
2026-01-27 14:11:54 [INFO] ADAPTER: Persistindo relato 6ca4f006e7c04ab685a220716104dd64 | owner=admin-123 status=created
2026-01-27 14:11:54 [ERROR] Erro ao persistir relato
Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\app\services\relato_effect_executor.py", line 97, in execute
    result = build_effect_result(
             ^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\services\effects\build_result.py", line 39, in build_effect_result
    return EffectResult(
           ^^^^^^^^^^^^^
TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'
2026-01-27 14:11:54 [WARNING] Falha na execu├º├úo de efeitos. Iniciando rollback compensat├│rio | total_executados=0
2026-01-27 14:11:54 [ERROR] Unhandled exception for POST /relatos/ (188.3ms): cannot access local variable 'result' where it is not associated with a value
Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 148, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\anyio\streams\memory.py", line 126, in receive
    raise EndOfStream from None
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\app\main.py", line 51, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    raise app_exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Python311\Lib\contextlib.py", line 155, in __exit__
    self.gen.throw(typ, value, traceback)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\archlog_sync\middleware.py", line 19, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 154, in call_next
    raise app_exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\fastapi\routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\workspace_projects_001\dermasync-api\app\routes\relatos.py", line 125, in criar_e_enviar_relato
    executor.execute(decision.effects)
  File "D:\workspace_projects_001\dermasync-api\app\services\relato_effect_executor.py", line 127, in execute
    persist_effect_result_firestore(result)
                                    ^^^^^^
UnboundLocalError: cannot access local variable 'result' where it is not associated with a value
___________________ test_create_relato_emits_typed_effects ____________________

    def test_create_relato_emits_typed_effects():
        actor = Actor(id="user-123", role=ActorRole.USER)
    
>       command = CreateRelato(
            relato_id="relato-1",
            owner_id="user-123",
            conteudo="Relato v├ílido",
            imagens={"antes": [], "durante": [], "depois": []},
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato.py:187: TypeError
_________________ test_create_relato_initial_state_is_created _________________

    def test_create_relato_initial_state_is_created():
        decision = decide(
>           command=CreateRelato(
            relato_id="relato-1",
            owner_id="user-123",
            conteudo="Relato v├ílido",
            imagens={"antes": [], "durante": [], "depois": []},
        ),
            actor=Actor(id="user-123", role=ActorRole.USER),
            current_state=None
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato.py:207: TypeError
________________ test_create_relato_allowed_from_initial_state ________________

    def test_create_relato_allowed_from_initial_state():
        """Testa que a cria├º├úo de relato ├® permitida a partir do estado inicial (None)."""
        actor = Actor(id="user-123", role=ActorRole.USER)
>       command = CreateRelato(
            relato_id="relato-456",
            owner_id="user-123",
            conteudo="Relato de teste",
            imagens={"antes": [], "durante": [], "depois": []}
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato_decision.py:19: TypeError
________________ test_create_relato_denied_when_already_exists ________________

    def test_create_relato_denied_when_already_exists():
        """Testa que a cria├º├úo de relato ├® negada quando o relato j├í existe (estado n├úo ├® None)."""
        actor = Actor(id="user-123", role=ActorRole.USER)
>       command = CreateRelato(
            relato_id="relato-456",
            owner_id="user-123",
            conteudo="Relato de teste",
            imagens={"antes": [], "durante": [], "depois": []}
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato_decision.py:38: TypeError
______________ test_create_relato_denied_from_any_existing_state ______________

    def test_create_relato_denied_from_any_existing_state():
        """Testa que a cria├º├úo de relato ├® negada a partir de qualquer estado existente."""
        actor = Actor(id="user-123", role=ActorRole.USER)
>       command = CreateRelato(
            relato_id="relato-456",
            owner_id="user-123",
            conteudo="Relato de teste",
            imagens={"antes": [], "durante": [], "depois": []}
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato_decision.py:58: TypeError
____________________ test_create_relato_effects_structure _____________________

    def test_create_relato_effects_structure():
        """Testa que a decis├úo de cria├º├úo retorna efeitos com a estrutura esperada."""
        actor = Actor(id="user-123", role=ActorRole.USER)
>       command = CreateRelato(
            relato_id="relato-456",
            owner_id="user-123",
            conteudo="Relato de teste",
            imagens={"antes": [{"filename": "img.jpg", "content": b"...", "content_type": "image/jpeg"}],
                     "durante": [], "depois": []}
        )
E       TypeError: CreateRelato.__init__() got an unexpected keyword argument 'imagens'

tests\domain\relato\test_create_relato_decision.py:81: TypeError
______________________ test_negar_aprovacao_estado_draft ______________________

    def test_negar_aprovacao_estado_draft():
        """N├úo ├® poss├¡vel aprovar um relato em estado DRAFT."""
        actor = Actor(id="admin-123", role=ActorRole.ADMIN)
        command = ApproveRelatoPublic(relato_id="relato-456")
    
        decision = decide(
            command=command,
            actor=actor,
>           current_state=RelatoStatus.DRAFT,
                          ^^^^^^^^^^^^^^^^^^
        )

tests\domain\relato\test_invalid_transitions.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <enum 'RelatoStatus'>, name = 'DRAFT'

    def __getattr__(cls, name):
        """
        Return the enum member matching `name`
    
        We use __getattr__ instead of descriptors or inserting into the enum
        class' __dict__ in order to support `name` and `value` being both
        properties for enum members (which live in the class' __dict__) and
        enum members themselves.
        """
        if _is_dunder(name):
            raise AttributeError(name)
        try:
            return cls._member_map_[name]
        except KeyError:
>           raise AttributeError(name) from None
E           AttributeError: DRAFT

C:\Python311\Lib\enum.py:783: AttributeError
______________________ test_negar_rejeicao_estado_draft _______________________

    def test_negar_rejeicao_estado_draft():
        """N├úo ├® poss├¡vel rejeitar um relato em estado DRAFT."""
        actor = Actor(id="admin-123", role=ActorRole.ADMIN)
        command = RejectRelato(relato_id="relato-456")
    
        decision = decide(
            command=command,
            actor=actor,
>           current_state=RelatoStatus.DRAFT,
                          ^^^^^^^^^^^^^^^^^^
        )

tests\domain\relato\test_invalid_transitions.py:102: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <enum 'RelatoStatus'>, name = 'DRAFT'

    def __getattr__(cls, name):
        """
        Return the enum member matching `name`
    
        We use __getattr__ instead of descriptors or inserting into the enum
        class' __dict__ in order to support `name` and `value` being both
        properties for enum members (which live in the class' __dict__) and
        enum members themselves.
        """
        if _is_dunder(name):
            raise AttributeError(name)
        try:
            return cls._member_map_[name]
        except KeyError:
>           raise AttributeError(name) from None
E           AttributeError: DRAFT

C:\Python311\Lib\enum.py:783: AttributeError
_______________ test_negar_marcar_como_processado_estado_draft ________________

    def test_negar_marcar_como_processado_estado_draft():
        """N├úo ├® poss├¡vel marcar um relato como processado a partir de DRAFT."""
        actor = Actor(id="system", role=ActorRole.SYSTEM)
        command = MarkRelatoAsProcessed(relato_id="relato-456")
    
        decision = decide(
            command=command,
            actor=actor,
>           current_state=RelatoStatus.DRAFT,
                          ^^^^^^^^^^^^^^^^^^
        )

tests\domain\relato\test_invalid_transitions.py:138: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <enum 'RelatoStatus'>, name = 'DRAFT'

    def __getattr__(cls, name):
        """
        Return the enum member matching `name`
    
        We use __getattr__ instead of descriptors or inserting into the enum
        class' __dict__ in order to support `name` and `value` being both
        properties for enum members (which live in the class' __dict__) and
        enum members themselves.
        """
        if _is_dunder(name):
            raise AttributeError(name)
        try:
            return cls._member_map_[name]
        except KeyError:
>           raise AttributeError(name) from None
E           AttributeError: DRAFT

C:\Python311\Lib\enum.py:783: AttributeError
______________________ test_submeter_relato_estado_draft ______________________

    def test_submeter_relato_estado_draft():
        """Testa a submiss├úo de um relato a partir do estado DRAFT."""
        actor = Actor(id="user-123", role=ActorRole.USER)
        command = SubmitRelato(relato_id="relato-456")
    
>       decision = decide(command=command, actor=actor, current_state=RelatoStatus.DRAFT)
                                                                      ^^^^^^^^^^^^^^^^^^

tests\domain\relato\test_submit_relato.py:21: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <enum 'RelatoStatus'>, name = 'DRAFT'

    def __getattr__(cls, name):
        """
        Return the enum member matching `name`
    
        We use __getattr__ instead of descriptors or inserting into the enum
        class' __dict__ in order to support `name` and `value` being both
        properties for enum members (which live in the class' __dict__) and
        enum members themselves.
        """
        if _is_dunder(name):
            raise AttributeError(name)
        try:
            return cls._member_map_[name]
        except KeyError:
>           raise AttributeError(name) from None
E           AttributeError: DRAFT

C:\Python311\Lib\enum.py:783: AttributeError
___________________ test_ux_effect_public_contract_snapshot ___________________

    def test_ux_effect_public_contract_snapshot():
        """
        Este teste protege o CONTRATO P├ÜBLICO de UX Effects.
        Qualquer altera├º├úo aqui ├® BREAKING CHANGE.
        """
    
        effect = ProcessingStartedUXEffect.default(
            relato_id="relato_123"
        )
    
        payload = serialize_ux_effects([effect])
    
        # Garantia 1: serializ├ível em JSON puro
        json.dumps(payload)
    
        # Garantia 2: shape p├║blico est├ível
>       assert payload == {
            "ux_effects": [
                {
                    "type": "processing_started",
                    "severity": "info",
                    "channel": "banner",
                    "timing": "after_processing",
                    "message": "Seu relato est├í sendo processado. Isso pode levar alguns instantes.",
                }
            ]
        }
E       AssertionError: assert [] == {'ux_effects'...ssing', ...}]}
E         
E         Full diff:
E         + []
E         - {
E         -     'ux_effects': [
E         -         {
E         -             'channel': 'banner',...
E         
E         ...Full output truncated (8 lines hidden), use '-vv' to show

tests\domain\ux_effects\test_ux_effect_public_contract.py:24: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:11:57,020", "level": "DEBUG", "logger": "app.services.ux_adapters", "message": "Ignoring non-UX domain effect: ProcessingStartedUXEffect"}
____________ test_multiple_ux_effects_preserve_order_and_contract _____________

    def test_multiple_ux_effects_preserve_order_and_contract():
        effects = [
            ProcessingStartedUXEffect.default(relato_id="relato_123"),
            RetryUXEffect.retrying(
                relato_id="relato_123",
                count=2,
            ),
        ]
    
        payload = serialize_ux_effects(effects)
    
        json.dumps(payload)
    
>       assert payload == {
            "ux_effects": [
                {
                    "type": "processing_started",
                    "severity": "info",
                    "channel": "banner",
                    "timing": "after_processing",
                    "message": "Seu relato est├í sendo processado. Isso pode levar alguns instantes.",
                },
                {
                    "type": "retrying",
                    "severity": "info",
                    "channel": "banner",
                    "timing": "immediate",
                    "message": "2 a├º├Áes est├úo sendo repetidas.",
                },
            ]
        }
E       AssertionError: assert [] == {'ux_effects'...diate', ...}]}
E         
E         Full diff:
E         + []
E         - {
E         -     'ux_effects': [
E         -         {
E         -             'channel': 'banner',...
E         
E         ...Full output truncated (15 lines hidden), use '-vv' to show

tests\domain\ux_effects\test_ux_effects_composition.py:22: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:11:57,054", "level": "DEBUG", "logger": "app.services.ux_adapters", "message": "Ignoring non-UX domain effect: ProcessingStartedUXEffect"}
{"timestamp": "2026-01-27 14:11:57,054", "level": "DEBUG", "logger": "app.services.ux_adapters", "message": "Ignoring non-UX domain effect: RetryUXEffect"}
__________________ test_persist_relato_marks_first_step_done __________________

    def test_persist_relato_marks_first_step_done():
        steps = default_step_definitions()
    
        effects = [
            EffectResult(
                type="PERSIST_RELATO",
                success=True,
>               executed_at=dt("2026-01-17T10:00:00")
                            ^^
            )
        ]
E       NameError: name 'dt' is not defined

tests\domain\ux_progress\test_ux_progress.py:31: NameError
___ test_upload_images_becomes_active_when_effect_exists_but_not_completed ____

    def test_upload_images_becomes_active_when_effect_exists_but_not_completed():
        steps = default_step_definitions()
    
        effects = [
>           EffectResult(type="PERSIST_RELATO", success=True),
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            EffectResult(type="UPLOAD_IMAGES", success=False)
        ]
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'type'

tests\domain\ux_progress\test_ux_progress.py:47: TypeError
_______________ test_upload_images_has_more_weight_in_progress ________________

    def test_upload_images_has_more_weight_in_progress():
        steps = default_step_definitions()
    
        effects = [
>           EffectResult(type="PERSIST_RELATO", success=True),
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            EffectResult(type="UPLOAD_IMAGES", success=True),
        ]
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'type'

tests\domain\ux_progress\test_ux_progress.py:62: TypeError
____________________ test_error_in_any_step_sets_has_error ____________________

    def test_error_in_any_step_sets_has_error():
        steps = default_step_definitions()
    
        effects = [
>           EffectResult(type="PERSIST_RELATO", success=True),
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            EffectResult(type="UPLOAD_IMAGES", success=False),
        ]
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'type'

tests\domain\ux_progress\test_ux_progress.py:74: TypeError
_________________ test_all_steps_done_marks_progress_complete _________________

    def test_all_steps_done_marks_progress_complete():
        steps = default_step_definitions()
    
        effects = [
>           EffectResult(type="PERSIST_RELATO", success=True),
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            EffectResult(type="UPLOAD_IMAGES", success=True),
            EffectResult(type="ENRICH_METADATA", success=True),
        ]
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'type'

tests\domain\ux_progress\test_ux_progress.py:87: TypeError
____________________ test_load_failed_effect_results_basic ____________________

    def test_load_failed_effect_results_basic():
        fake_doc = Mock()
        fake_doc.to_dict.return_value = {
            "relato_id": "rel-1",
            "effect_type": "PERSIST_RELATO",
            "effect_ref": "rel-1",
            "success": False,
            "metadata": {"attempt": 1},
            "error": "network error",
            "executed_at": datetime.utcnow(),
        }
    
        fake_collection = Mock()
        fake_collection.where.return_value = fake_collection
        fake_collection.order_by.return_value = fake_collection
        fake_collection.limit.return_value = fake_collection
        fake_collection.stream.return_value = [fake_doc]
    
        fake_db = Mock()
        fake_db.collection.return_value = fake_collection
    
        with patch(
            "app.infra.retry.retry_repository.get_firestore_client",
            return_value=fake_db,
        ):
            results = load_failed_effect_results(limit=10)
    
>       assert len(results) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests\infra\retry\test_retry_repository.py:36: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:11:57,222", "level": "ERROR", "logger": "app.infra.retry.retry_repository", "message": "Falha ao materializar EffectResult | doc_id=<Mock name='mock.id' id='2091937412944'>"}
{"timestamp": "2026-01-27 14:11:57,225", "level": "INFO", "logger": "app.infra.retry.retry_repository", "message": "RetryRepository | carregados=0 | limit=10"}
------------------------------ Captured log call ------------------------------
2026-01-27 14:11:57 [ERROR] Falha ao materializar EffectResult | doc_id=<Mock name='mock.id' id='2091937412944'>
Traceback (most recent call last):
  File "D:\workspace_projects_001\dermasync-api\app\infra\retry\retry_repository.py", line 50, in load_failed_effect_results
    result = EffectResult(
             ^^^^^^^^^^^^^
TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'
2026-01-27 14:11:57 [INFO] RetryRepository | carregados=0 | limit=10
_______________ test_retry_scheduler_runs_and_returns_decisions _______________

mocker = <pytest_mock.plugin.MockerFixture object at 0x000001E711E9DA10>

    def test_retry_scheduler_runs_and_returns_decisions(mocker):
>       fake_result = EffectResult(
            relato_id="r1",
            effect_type="TEST",
            effect_ref="ref-123",
            success=False,
            metadata={},
            error="test error",
            executed_at=datetime.utcnow()
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\infra\retry\test_retry_scheduler.py:27: TypeError
_____________ test_effect_result_repository_reads_from_firestore ______________

    def test_effect_result_repository_reads_from_firestore():
        client = firestore.Client()
        repo = EffectResultRepository(firestore_client=client)
    
        relato_id = "relato_integration_1"
    
        client.collection("effect_results").add({
            "relato_id": relato_id,
            "effect_type": "PERSIST_RELATO",
            "success": True,
            "executed_at": datetime.utcnow(),
            "error": None,
        })
    
        results = repo.fetch_by_relato_id(relato_id)
    
>       assert len(results) == 1
E       AssertionError: assert 11 == 1
E        +  where 11 = len([EffectResult(type='PERSIST_RELATO', success=True, executed_at=DatetimeWithNanoseconds(2026, 1, 23, 9, 1, 12, 819992, tzinfo=datetime.timezone.utc), error_message=None, metadata=None), EffectResult(type='PERSIST_RELATO', success=True, executed_at=DatetimeWithNanoseconds(2026, 1, 24, 17, 30, 17, 804956, tzinfo=datetime.timezone.utc), error_message=None, metadata=None), EffectResult(type='PERSIST_RELATO', success=True, executed_at=DatetimeWithNanoseconds(2026, 1, 26, 18, 31, 43, 809187, tzinfo=datetime.timezone.utc), error_message=None, metadata=None), EffectResult(type='PERSIST_RELATO', success=True, executed_at=DatetimeWithNanoseconds(2026, 1, 26, 18, 47, 49, 61347, tzinfo=datetime.timezone.utc), error_message=None, metadata=None), EffectResult(type='PERSIST_RELATO', success=True, executed_at=DatetimeWithNanoseconds(2026, 1, 26, 21, 47, 35, 450343, tzinfo=datetime.timezone.utc), error_message=None, metadata=None), EffectResult(type='PERSIST_RELATO', success=True, executed_at=DatetimeWithNanoseconds(2026, 1, 26, 21, 54, 58, 894728, tzinfo=datetime.timezone.utc), error_message=None, metadata=None), ...])

tests\integration\test_relato_progress_firestore.py:24: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:02,226", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "Starting new HTTPS connection (1): oauth2.googleapis.com:443"}
{"timestamp": "2026-01-27 14:12:02,442", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "https://oauth2.googleapis.com:443 \"POST /token HTTP/1.1\" 200 None"}
________________ test_post_relatos_with_real_multipart_upload _________________

    def test_post_relatos_with_real_multipart_upload():
    
    
        # -----------------------------------
        # Auth override (correto)
        # -----------------------------------
        mock_user = User(
            id="user-123",
            email="user@test.com",
            role="usuario_logado"
        )
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        client = TestClient(app)
    
        # -----------------------------------
        # Payload v├ílido (schema real)
        # -----------------------------------
        payload = {
            "descricao": "Relato com imagem real",
            "consentimento": True,
            "idade": 33
        }
    
        # -----------------------------------
        # Arquivo real em mem├│ria
        # -----------------------------------
        fake_image_bytes = BytesIO(b"fake-image-bytes-123")
        fake_image_bytes.name = "antes.jpg"
    
        files = {
            "imagens_antes": (
                "antes.jpg",
                fake_image_bytes,
                "image/jpeg",
            )
        }
    
        try:
            # -----------------------------------
            # Mock SOMENTE do executor
            # -----------------------------------
            with patch("app.routes.relatos.RelatoEffectExecutor") as mock_exec:
                exec_instance = MagicMock()
                mock_exec.return_value = exec_instance
    
                response = client.post(
                    "/relatos/",
                    data={"payload": json.dumps(payload)},
                    files=files,
                )
    
                # -----------------------------------
                # Asser├º├Áes cr├¡ticas
                # -----------------------------------
                assert response.status_code == 201
    
                body = response.json()
>               assert "relato_id" in body
E               AssertionError: assert 'relato_id' in {'data': {'relato_id': '8e6ecf292a054220bca0f23c3254e469', 'status': 'created'}, 'ux_effects': [{'channel': 'progress', 'message': 'Relato recebido e salvo.', 'relato_id': '8e6ecf292a054220bca0f23c3254e469', 'severity': 'info', ...}, {'channel': 'progress', 'message': 'Imagens enviadas para processamento.', 'relato_id': '8e6ecf292a054220bca0f23c3254e469', 'severity': 'info', ...}]}

tests\routes\test_relatos_multipart.py:68: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:08,026", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
{"timestamp": "2026-01-27 14:12:08,042", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_part_begin with no data"}
{"timestamp": "2026-01-27 14:12:08,043", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_field with data[36:55]"}
{"timestamp": "2026-01-27 14:12:08,043", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_value with data[57:82]"}
{"timestamp": "2026-01-27 14:12:08,043", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_end with no data"}
{"timestamp": "2026-01-27 14:12:08,043", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_headers_finished with no data"}
{"timestamp": "2026-01-27 14:12:08,044", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_part_data with data[86:161]"}
{"timestamp": "2026-01-27 14:12:08,044", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_part_end with no data"}
{"timestamp": "2026-01-27 14:12:08,044", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_part_begin with no data"}
{"timestamp": "2026-01-27 14:12:08,044", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_field with data[199:218]"}
{"timestamp": "2026-01-27 14:12:08,044", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_value with data[220:273]"}
{"timestamp": "2026-01-27 14:12:08,045", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_end with no data"}
{"timestamp": "2026-01-27 14:12:08,045", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_field with data[275:287]"}
{"timestamp": "2026-01-27 14:12:08,045", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_value with data[289:299]"}
{"timestamp": "2026-01-27 14:12:08,045", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_header_end with no data"}
{"timestamp": "2026-01-27 14:12:08,045", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_headers_finished with no data"}
{"timestamp": "2026-01-27 14:12:08,046", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_part_data with data[303:323]"}
{"timestamp": "2026-01-27 14:12:08,046", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_part_end with no data"}
{"timestamp": "2026-01-27 14:12:08,046", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_end with no data"}
{"timestamp": "2026-01-27 14:12:08,054", "level": "INFO", "logger": "root", "message": "POST /relatos/ testclient -> 201 (14.7ms) body_len=363"}
{"timestamp": "2026-01-27 14:12:08,058", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/relatos/ \"HTTP/1.1 201 Created\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:12:08] [INFO] [request_logger] POST /relatos/ Status: 201 Tempo: 14.69ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:12:08 [INFO] POST /relatos/ testclient -> 201 (14.7ms) body_len=363
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 201 Created"
____________________ test_upload_failure_triggers_rollback ____________________

    def test_upload_failure_triggers_rollback():
        from app.services.relato_effect_executor import RelatoEffectExecutor
        from app.domain.relato.effects import UploadImagesEffect, RollbackImagesEffect
    
        upload_called = False
        rollback_called = False
    
        def fake_upload(relato_id, imagens):
            nonlocal upload_called
            upload_called = True
            raise RuntimeError("upload failed")
    
        def fake_rollback(image_ids):
            nonlocal rollback_called
            rollback_called = True
    
    
        executor = RelatoEffectExecutor(
            upload_images=fake_upload,
            rollback_images=fake_rollback,
            persist_relato=lambda e: None,
            enqueue_processing=lambda e: None,
            emit_event=lambda e: None,
            update_relato_status=lambda e: None,
    
        )
    
        effects = [
>           UploadImagesEffect(relato_id="r1", imagens={})
        ]
E       TypeError: UploadImagesEffect.__init__() got an unexpected keyword argument 'imagens'

tests\routes\test_relatos_multipart.py:106: TypeError
________________ test_effect_result_persist_and_fetch_success _________________

    def test_effect_result_persist_and_fetch_success():
        """
        Teste de integra├º├úo real com Firestore.
        Prova que EffectResult ├® persistido e recuper├ível
        pela chave de idempot├¬ncia.
        """
    
        from app.services.effects.persist_firestore import persist_effect_result_firestore
        from app.services.effects.fetch_firestore import fetch_effect_result_success
        from app.services.effects.result import EffectResult
    
>       effect = EffectResult(
            relato_id="relato-test-001",
            effect_type="UPLOAD_IMAGES",
            effect_ref="relato-test-001",
            success=True,
            metadata={"total_images": 2},
            error=None,
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\routes\test_relatos_multipart.py:129: TypeError
__________________________ test_post_relatos_success __________________________

    def test_post_relatos_success():
        """Testa a cria├º├úo bem-sucedida de um relato (status 201)."""
        # Mock dependencies
        mock_user = User(id="user-123", email="test@example.com", role="usuario_logado")
    
        # Mock the domain decision
        mock_decision = Decision(
            allowed=True,
            reason=None,
>           next_state=RelatoStatus.DRAFT,
                       ^^^^^^^^^^^^^^^^^^
            previous_state=None,
            effects=["effect1", "effect2"]  # Mock effects
        )

tests\routes\test_relatos_post.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <enum 'RelatoStatus'>, name = 'DRAFT'

    def __getattr__(cls, name):
        """
        Return the enum member matching `name`
    
        We use __getattr__ instead of descriptors or inserting into the enum
        class' __dict__ in order to support `name` and `value` being both
        properties for enum members (which live in the class' __dict__) and
        enum members themselves.
        """
        if _is_dunder(name):
            raise AttributeError(name)
        try:
            return cls._member_map_[name]
        except KeyError:
>           raise AttributeError(name) from None
E           AttributeError: DRAFT

C:\Python311\Lib\enum.py:783: AttributeError
_____________________ test_post_relatos_denied_by_domain ______________________

    def test_post_relatos_denied_by_domain():
        """Testa que a rota retorna 403 quando o dom├¡nio nega a cria├º├úo."""
        # Mock dependencies
        mock_user = User(id="user-123", email="test@example.com", role="usuario_logado")
    
        # Mock the domain decision (denied)
        mock_decision = Decision(
            allowed=False,
            reason="Relato j├í existe.",
            next_state=None,
>           previous_state=RelatoStatus.DRAFT,
                           ^^^^^^^^^^^^^^^^^^
            effects=[]  # No effects when denied
        )

tests\routes\test_relatos_post.py:85: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <enum 'RelatoStatus'>, name = 'DRAFT'

    def __getattr__(cls, name):
        """
        Return the enum member matching `name`
    
        We use __getattr__ instead of descriptors or inserting into the enum
        class' __dict__ in order to support `name` and `value` being both
        properties for enum members (which live in the class' __dict__) and
        enum members themselves.
        """
        if _is_dunder(name):
            raise AttributeError(name)
        try:
            return cls._member_map_[name]
        except KeyError:
>           raise AttributeError(name) from None
E           AttributeError: DRAFT

C:\Python311\Lib\enum.py:783: AttributeError
___________________ test_post_relatos_missing_consentimento ___________________

    def test_post_relatos_missing_consentimento():
        """Testa que a rota retorna 400 quando consentimento n├úo ├® informado."""
        # Mock dependencies
        mock_user = User(id="user-123", email="test@example.com", role="usuario_logado")
    
        # Create a test client
        client = TestClient(app)
    
        # Prepare payload without consentimento
        payload = {
            "descricao": "Relato de teste",
            "consentimento": False,  # Explicitly false
            "tags": ["teste"],
            "tratamentos": ["tratamento1"]
        }
    
        with patch("app.auth.dependencies.get_current_user", return_value=mock_user):
            # Make the request
            response = client.post(
                "/relatos",
                data={"payload": json.dumps(payload)},
            )
    
            # Assertions
>           assert response.status_code == status.HTTP_400_BAD_REQUEST
E           assert 401 == 400
E            +  where 401 = <Response [401 Unauthorized]>.status_code
E            +  and   400 = status.HTTP_400_BAD_REQUEST

tests\routes\test_relatos_post.py:140: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:08,316", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
{"timestamp": "2026-01-27 14:12:08,333", "level": "INFO", "logger": "root", "message": "POST /relatos testclient -> 307 (1.0ms) body_len=169"}
{"timestamp": "2026-01-27 14:12:08,336", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/relatos \"HTTP/1.1 307 Temporary Redirect\""}
{"timestamp": "2026-01-27 14:12:08,339", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
{"timestamp": "2026-01-27 14:12:08,356", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_start with no data"}
{"timestamp": "2026-01-27 14:12:08,356", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_name with data[0:7]"}
{"timestamp": "2026-01-27 14:12:08,357", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_data with data[8:169]"}
{"timestamp": "2026-01-27 14:12:08,357", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_end with no data"}
{"timestamp": "2026-01-27 14:12:08,357", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_end with no data"}
{"timestamp": "2026-01-27 14:12:08,359", "level": "DEBUG", "logger": "app.auth.dependencies", "message": "Auth dependency: Authorization header raw -> None"}
{"timestamp": "2026-01-27 14:12:08,360", "level": "INFO", "logger": "app.auth.dependencies", "message": "AUTH REJECT: Authorization header ausente."}
{"timestamp": "2026-01-27 14:12:08,361", "level": "INFO", "logger": "root", "message": "POST /relatos/ testclient -> 401 (6.9ms) body_len=169"}
{"timestamp": "2026-01-27 14:12:08,365", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/relatos/ \"HTTP/1.1 401 Unauthorized\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:12:08] [INFO] [request_logger] POST /relatos Status: 307 Tempo: 0.96ms[0m
[32m[2026-01-27 14:12:08] [INFO] [request_logger] POST /relatos/ Status: 401 Tempo: 6.88ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:12:08 [INFO] POST /relatos testclient -> 307 (1.0ms) body_len=169
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos "HTTP/1.1 307 Temporary Redirect"
2026-01-27 14:12:08 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:12:08 [INFO] POST /relatos/ testclient -> 401 (6.9ms) body_len=169
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 401 Unauthorized"
__________________ test_post_relatos_no_consentimento_field ___________________

    def test_post_relatos_no_consentimento_field():
        """Testa que a rota retorna 400 quando campo consentimento est├í ausente."""
        # Mock dependencies
        mock_user = User(id="user-123", email="test@example.com", role="usuario_logado")
    
        # Create a test client
        client = TestClient(app)
    
        # Prepare payload without consentimento field
        payload = {
            "descricao": "Relato de teste",
            "tags": ["teste"],
            "tratamentos": ["tratamento1"]
        }
    
        with patch("app.auth.dependencies.get_current_user", return_value=mock_user):
            # Make the request
            response = client.post(
                "/relatos",
                data={"payload": json.dumps(payload)},
            )
    
            # Assertions - this might be a validation error depending on schema
            # If the schema requires consentimento, this will be 422, otherwise 400 if checked in code
>           assert response.status_code in [status.HTTP_400_BAD_REQUEST, status.HTTP_422_UNPROCESSABLE_ENTITY]
E           assert 401 in [400, 422]
E            +  where 401 = <Response [401 Unauthorized]>.status_code

tests\routes\test_relatos_post.py:169: AssertionError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:08,393", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
{"timestamp": "2026-01-27 14:12:08,411", "level": "INFO", "logger": "root", "message": "POST /relatos testclient -> 307 (2.0ms) body_len=137"}
{"timestamp": "2026-01-27 14:12:08,414", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/relatos \"HTTP/1.1 307 Temporary Redirect\""}
{"timestamp": "2026-01-27 14:12:08,416", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
{"timestamp": "2026-01-27 14:12:08,432", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_start with no data"}
{"timestamp": "2026-01-27 14:12:08,432", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_name with data[0:7]"}
{"timestamp": "2026-01-27 14:12:08,432", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_data with data[8:137]"}
{"timestamp": "2026-01-27 14:12:08,432", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_field_end with no data"}
{"timestamp": "2026-01-27 14:12:08,433", "level": "DEBUG", "logger": "python_multipart.multipart", "message": "Calling on_end with no data"}
{"timestamp": "2026-01-27 14:12:08,435", "level": "DEBUG", "logger": "app.auth.dependencies", "message": "Auth dependency: Authorization header raw -> None"}
{"timestamp": "2026-01-27 14:12:08,435", "level": "INFO", "logger": "app.auth.dependencies", "message": "AUTH REJECT: Authorization header ausente."}
{"timestamp": "2026-01-27 14:12:08,438", "level": "INFO", "logger": "root", "message": "POST /relatos/ testclient -> 401 (7.7ms) body_len=137"}
{"timestamp": "2026-01-27 14:12:08,441", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://testserver/relatos/ \"HTTP/1.1 401 Unauthorized\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:12:08] [INFO] [request_logger] POST /relatos Status: 307 Tempo: 1.00ms[0m
[32m[2026-01-27 14:12:08] [INFO] [request_logger] POST /relatos/ Status: 401 Tempo: 7.22ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:12:08 [INFO] POST /relatos testclient -> 307 (2.0ms) body_len=137
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos "HTTP/1.1 307 Temporary Redirect"
2026-01-27 14:12:08 [INFO] AUTH REJECT: Authorization header ausente.
2026-01-27 14:12:08 [INFO] POST /relatos/ testclient -> 401 (7.7ms) body_len=137
2026-01-27 14:12:08 [INFO] HTTP Request: POST http://testserver/relatos/ "HTTP/1.1 401 Unauthorized"
______________ test_post_relatos_executor_not_called_when_denied ______________

    def test_post_relatos_executor_not_called_when_denied():
        """Testa que o executor de efeitos N├âO ├® chamado quando decision.allowed == False."""
        # Mock dependencies
        mock_user = User(id="user-123", email="test@example.com", role="usuario_logado")
    
        # Mock the domain decision (denied)
        mock_decision = Decision(
            allowed=False,
            reason="Relato j├í existe.",
            next_state=None,
>           previous_state=RelatoStatus.DRAFT,
                           ^^^^^^^^^^^^^^^^^^
            effects=[]  # No effects when denied
        )

tests\routes\test_relatos_post.py:182: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <enum 'RelatoStatus'>, name = 'DRAFT'

    def __getattr__(cls, name):
        """
        Return the enum member matching `name`
    
        We use __getattr__ instead of descriptors or inserting into the enum
        class' __dict__ in order to support `name` and `value` being both
        properties for enum members (which live in the class' __dict__) and
        enum members themselves.
        """
        if _is_dunder(name):
            raise AttributeError(name)
        try:
            return cls._member_map_[name]
        except KeyError:
>           raise AttributeError(name) from None
E           AttributeError: DRAFT

C:\Python311\Lib\enum.py:783: AttributeError
_____________________ test_get_relato_progress_forbidden ______________________

client = <httpx.AsyncClient object at 0x000001E71149A110>
mock_current_user_usuario_logado = None
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001E71149B450>

    @pytest.mark.asyncio
    async def test_get_relato_progress_forbidden(
        client,
        mock_current_user_usuario_logado,
        monkeypatch,
    ):
        from fastapi import HTTPException
    
        async def fake_get_relato_by_id(*_, **__):
            raise HTTPException(status_code=403, detail="Acesso negado")
    
        monkeypatch.setattr(
            "app.services.relatos_service.get_relato_by_id",
            fake_get_relato_by_id,
        )
    
        response = await client.get("/relatos/relato-123/progress")
>       assert response.status_code == status.HTTP_403_FORBIDDEN
E       assert 200 == 403
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   403 = status.HTTP_403_FORBIDDEN

tests\routes\test_relatos_progress.py:38: AssertionError
---------------------------- Captured stdout setup ----------------------------
{"timestamp": "2026-01-27 14:12:08,664", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:08,684", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Getting progress for relato_id=relato-123 user=user_123"}
{"timestamp": "2026-01-27 14:12:13,039", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "Starting new HTTPS connection (1): oauth2.googleapis.com:443"}
{"timestamp": "2026-01-27 14:12:13,337", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "https://oauth2.googleapis.com:443 \"POST /token HTTP/1.1\" 200 None"}
{"timestamp": "2026-01-27 14:12:13,489", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Found 26 effect records for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:13,490", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Converted effect records to UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:13,490", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Sorted UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:13,491", "level": "DEBUG", "logger": "app.core.projections.progress_projector", "message": "Projecting progress for relato_id=relato-123 with 26 effects"}
{"timestamp": "2026-01-27 14:12:13,492", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Projected progress for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:13,495", "level": "INFO", "logger": "root", "message": "GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4814.8ms) body_len=0"}
{"timestamp": "2026-01-27 14:12:13,499", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/relatos/relato-123/progress \"HTTP/1.1 200 OK\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:12:13] [INFO] [request_logger] GET /relatos/relato-123/progress Status: 200 Tempo: 4812.69ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:12:13 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4814.8ms) body_len=0
2026-01-27 14:12:13 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
_______________________ test_get_relato_progress_empty ________________________

client = <httpx.AsyncClient object at 0x000001E711BBF790>
mock_current_user_usuario_logado = None
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001E711BBF8D0>

    @pytest.mark.asyncio
    async def test_get_relato_progress_empty(
        client,
        mock_current_user_usuario_logado,
        monkeypatch,
    ):
        async def fake_get_relato_by_id(*_, **__):
            return {"id": "relato-123"}
    
        def fake_fetch_progress(relato_id: str):
            return {
                "relato_id": relato_id,
                "total_effects": 0,
                "completed": 0,
                "failed": 0,
                "progress_pct": 0,
                "effects": [],
            }
    
        monkeypatch.setattr(
            "app.services.relatos_service.get_relato_by_id",
            fake_get_relato_by_id,
        )
    
        monkeypatch.setattr(
            "app.services.readmodels.relato_progress.fetch_relato_progress",
            fake_fetch_progress,
        )
    
        response = await client.get("/relatos/relato-123/progress")
        data = response.json()
    
        assert response.status_code == 200
>       assert data["progress_pct"] == 0
E       assert 0.42857142857142855 == 0

tests\routes\test_relatos_progress.py:78: AssertionError
---------------------------- Captured stdout setup ----------------------------
{"timestamp": "2026-01-27 14:12:13,567", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:13,615", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Getting progress for relato_id=relato-123 user=user_123"}
{"timestamp": "2026-01-27 14:12:18,032", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "Starting new HTTPS connection (1): oauth2.googleapis.com:443"}
{"timestamp": "2026-01-27 14:12:18,288", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "https://oauth2.googleapis.com:443 \"POST /token HTTP/1.1\" 200 None"}
{"timestamp": "2026-01-27 14:12:18,433", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Found 26 effect records for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:18,434", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Converted effect records to UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:18,435", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Sorted UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:18,435", "level": "DEBUG", "logger": "app.core.projections.progress_projector", "message": "Projecting progress for relato_id=relato-123 with 26 effects"}
{"timestamp": "2026-01-27 14:12:18,435", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Projected progress for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:18,438", "level": "INFO", "logger": "root", "message": "GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4830.0ms) body_len=0"}
{"timestamp": "2026-01-27 14:12:18,441", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/relatos/relato-123/progress \"HTTP/1.1 200 OK\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:12:18] [INFO] [request_logger] GET /relatos/relato-123/progress Status: 200 Tempo: 4827.46ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:12:18 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4830.0ms) body_len=0
2026-01-27 14:12:18 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
_________________ test_get_relato_progress_partial_with_error _________________

client = <httpx.AsyncClient object at 0x000001E7121BD210>
mock_current_user_usuario_logado = None
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001E7121BE610>

    @pytest.mark.asyncio
    async def test_get_relato_progress_partial_with_error(
        client,
        mock_current_user_usuario_logado,
        monkeypatch,
    ):
        async def fake_get_relato_by_id(*_, **__):
            return {"id": "relato-123"}
    
        def fake_fetch_progress(relato_id: str):
            return {
                "relato_id": relato_id,
                "total_effects": 3,
                "completed": 2,
                "failed": 1,
                "progress_pct": 66,
                "effects": [
                    {"effect_type": "PERSIST_RELATO", "success": True},
                    {"effect_type": "UPLOAD_IMAGES", "success": False},
                    {"effect_type": "ENQUEUE_PROCESSING", "success": True},
                ],
            }
    
        monkeypatch.setattr(
            "app.services.relatos_service.get_relato_by_id",
            fake_get_relato_by_id,
        )
    
        monkeypatch.setattr(
            "app.services.readmodels.relato_progress.fetch_relato_progress",
            fake_fetch_progress,
        )
    
        response = await client.get("/relatos/relato-123/progress")
        data = response.json()
    
        assert response.status_code == 200
>       assert data["failed"] == 1
               ^^^^^^^^^^^^^^
E       KeyError: 'failed'

tests\routes\test_relatos_progress.py:123: KeyError
---------------------------- Captured stdout setup ----------------------------
{"timestamp": "2026-01-27 14:12:18,478", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:18,507", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Getting progress for relato_id=relato-123 user=user_123"}
{"timestamp": "2026-01-27 14:12:22,762", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "Starting new HTTPS connection (1): oauth2.googleapis.com:443"}
{"timestamp": "2026-01-27 14:12:23,008", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "https://oauth2.googleapis.com:443 \"POST /token HTTP/1.1\" 200 None"}
{"timestamp": "2026-01-27 14:12:23,172", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Found 26 effect records for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:23,173", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Converted effect records to UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:23,173", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Sorted UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:23,174", "level": "DEBUG", "logger": "app.core.projections.progress_projector", "message": "Projecting progress for relato_id=relato-123 with 26 effects"}
{"timestamp": "2026-01-27 14:12:23,174", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Projected progress for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:23,176", "level": "INFO", "logger": "root", "message": "GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4673.7ms) body_len=0"}
{"timestamp": "2026-01-27 14:12:23,180", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/relatos/relato-123/progress \"HTTP/1.1 200 OK\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:12:23] [INFO] [request_logger] GET /relatos/relato-123/progress Status: 200 Tempo: 4672.48ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:12:23 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4673.7ms) body_len=0
2026-01-27 14:12:23 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
______________________ test_get_relato_progress_complete ______________________

client = <httpx.AsyncClient object at 0x000001E7115D2A50>
mock_current_user_usuario_logado = None
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001E7115D3950>

    @pytest.mark.asyncio
    async def test_get_relato_progress_complete(
        client,
        mock_current_user_usuario_logado,
        monkeypatch,
    ):
        async def fake_get_relato_by_id(*_, **__):
            return {"id": "relato-123"}
    
        def fake_fetch_progress(relato_id: str):
            return {
                "relato_id": relato_id,
                "total_effects": 2,
                "completed": 2,
                "failed": 0,
                "progress_pct": 100,
                "effects": [
                    {"effect_type": "PERSIST_RELATO", "success": True},
                    {"effect_type": "UPLOAD_IMAGES", "success": True},
                ],
            }
    
        monkeypatch.setattr(
            "app.services.relatos_service.get_relato_by_id",
            fake_get_relato_by_id,
        )
    
        monkeypatch.setattr(
            "app.services.readmodels.relato_progress.fetch_relato_progress",
            fake_fetch_progress,
        )
    
        response = await client.get("/relatos/relato-123/progress")
        data = response.json()
    
        assert response.status_code == 200
>       assert data["progress_pct"] == 100
E       assert 0.42857142857142855 == 100

tests\routes\test_relatos_progress.py:167: AssertionError
---------------------------- Captured stdout setup ----------------------------
{"timestamp": "2026-01-27 14:12:23,215", "level": "DEBUG", "logger": "asyncio", "message": "Using proactor: IocpProactor"}
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:23,249", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Getting progress for relato_id=relato-123 user=user_123"}
{"timestamp": "2026-01-27 14:12:27,653", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "Starting new HTTPS connection (1): oauth2.googleapis.com:443"}
{"timestamp": "2026-01-27 14:12:27,883", "level": "DEBUG", "logger": "urllib3.connectionpool", "message": "https://oauth2.googleapis.com:443 \"POST /token HTTP/1.1\" 200 None"}
{"timestamp": "2026-01-27 14:12:28,014", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Found 26 effect records for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:28,015", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Converted effect records to UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:28,015", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Sorted UXEffectRecords for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:28,015", "level": "DEBUG", "logger": "app.core.projections.progress_projector", "message": "Projecting progress for relato_id=relato-123 with 26 effects"}
{"timestamp": "2026-01-27 14:12:28,015", "level": "DEBUG", "logger": "app.routes.relatos_progress", "message": "Projected progress for relato_id=relato-123"}
{"timestamp": "2026-01-27 14:12:28,018", "level": "INFO", "logger": "root", "message": "GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4772.1ms) body_len=0"}
{"timestamp": "2026-01-27 14:12:28,019", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/relatos/relato-123/progress \"HTTP/1.1 200 OK\""}
---------------------------- Captured stderr call -----------------------------
[32m[2026-01-27 14:12:28] [INFO] [request_logger] GET /relatos/relato-123/progress Status: 200 Tempo: 4771.12ms[0m
------------------------------ Captured log call ------------------------------
2026-01-27 14:12:28 [INFO] GET /relatos/relato-123/progress 127.0.0.1 -> 200 (4772.1ms) body_len=0
2026-01-27 14:12:28 [INFO] HTTP Request: GET http://test/relatos/relato-123/progress "HTTP/1.1 200 OK"
__________ test_persist_effect_result_firestore_accepts_uuid_fields ___________

    def test_persist_effect_result_firestore_accepts_uuid_fields():
        """
        Garantia arquitetural:
        - UUIDs N├âO podem vazar como objetos para o Firestore
        - Persist├¬ncia N├âO pode lan├ºar exce├º├úo
        """
    
>       fake_result = EffectResult(
            relato_id=uuid.uuid4(),
            effect_type="PERSIST_RELATO",
            effect_ref=uuid.uuid4(),
            success=True,
            metadata={
                "image_id": uuid.uuid4(),
                "attempt": 1,
            },
            error=None,
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_persist_effect_result_firestore.py:16: TypeError
________ test_persist_effect_result_firestore_rejects_raw_uuid_values _________

    def test_persist_effect_result_firestore_rejects_raw_uuid_values():
        """
        Contrato:
        - Nenhum uuid.UUID pode chegar cru ao Firestore
        - Persist├¬ncia deve normalizar antes de set()
        """
    
>       fake_result = EffectResult(
            relato_id=uuid.uuid4(),
            effect_type="PERSIST_RELATO",
            effect_ref=uuid.uuid4(),
            success=True,
            metadata={
                "image_id": uuid.uuid4(),
            },
            error=None,
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_persist_effect_result_firestore.py:55: TypeError
___ test_persist_effect_result_firestore_normalizes_uuid_before_persisting ____

    def test_persist_effect_result_firestore_normalizes_uuid_before_persisting():
        """
        Contrato forte:
        - UUIDs DEVEM ser convertidos antes de chegar ao Firestore
        """
    
>       fake_result = EffectResult(
            relato_id=uuid.UUID("0f8e6e03-12aa-402a-8346-e1684de998b3"),
            effect_type="PERSIST_RELATO",
            effect_ref=uuid.UUID("11111111-2222-3333-4444-555555555555"),
            success=True,
            metadata={
                "image_id": uuid.UUID("aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"),
            },
            error=None,
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_persist_effect_result_firestore.py:102: TypeError
____________________________ test_classify_timeout ____________________________

    def test_classify_timeout():
        classifier = DefaultRetryClassifier()
    
>       result = EffectResult(
            relato_id="r1",
            effect_type="UPLOAD_IMAGE",
            effect_ref="x",
            success=False,
            metadata=None,
            error="Request timeout while uploading",
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_classifier.py:14: TypeError
_________________________ test_classify_invalid_input _________________________

    def test_classify_invalid_input():
        classifier = DefaultRetryClassifier()
    
>       result = EffectResult(
            relato_id="r1",
            effect_type="PERSIST_RELATO",
            effect_ref="draft",
            success=False,
            metadata=None,
            error="Invalid payload structure",
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_classifier.py:40: TypeError
____________________________ test_classify_unknown ____________________________

    def test_classify_unknown():
        classifier = DefaultRetryClassifier()
    
>       result = EffectResult(
            relato_id="r1",
            effect_type="ENQUEUE_JOB",
            effect_ref="r1",
            success=False,
            metadata=None,
            error="Something weird happened",
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_classifier.py:64: TypeError
__________________________ test_retry_effect_success __________________________

    def test_retry_effect_success():
        clear_registry()
    
        mock_executor = Mock()
        register_effect_executor("UPLOAD_IMAGE", mock_executor)
    
>       fake_result = EffectResult(
            relato_id="r1",
            effect_type="UPLOAD_IMAGE",
            effect_ref="img123",
            success=False,
            metadata={"path": "x/y.jpg"},
            error="fail",
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_effect.py:19: TypeError
__________________ test_retry_effect_unsupported_type_raises __________________

    def test_retry_effect_unsupported_type_raises():
        clear_registry()
    
>       fake_result = EffectResult(
            relato_id="r1",
            effect_type="UNKNOWN_EFFECT",
            effect_ref="x",
            success=False,
            metadata={},
            error="fail",
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_effect_unsupported.py:13: TypeError
__________________________ test_retry_persist_relato __________________________

executor = <app.services.relato_effect_executor.RelatoEffectExecutor object at 0x000001E711944ED0>

    def test_retry_persist_relato(executor):
        """
        Deve reexecutar PersistRelatoEffect a partir de EffectResult.
        """
        effect_data = {
            "owner_id": "user-123",
            "status": "novo",
            "conteudo": "conteudo",
            "imagens": {},
        }
>       result = EffectResult(
            relato_id="relato-123",
            effect_type="PERSIST_RELATO",
            effect_ref="relato-123",
            success=False,
            metadata={"effect_data": effect_data},
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_executor.py:49: TypeError
________________________ test_retry_enqueue_processing ________________________

executor = <app.services.relato_effect_executor.RelatoEffectExecutor object at 0x000001E711353810>

    def test_retry_enqueue_processing(executor):
        """
        Deve reexecutar EnqueueProcessingEffect.
        """
>       result = EffectResult(
            relato_id="relato-456",
            effect_type="ENQUEUE_PROCESSING",
            effect_ref="relato-456",
            success=False,
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_executor.py:68: TypeError
____________________________ test_retry_emit_event ____________________________

executor = <app.services.relato_effect_executor.RelatoEffectExecutor object at 0x000001E711041D90>

    def test_retry_emit_event(executor):
        """
        Deve reexecutar EmitDomainEventEffect com payload preservado.
        """
>       result = EffectResult(
            relato_id="relato-789",
            effect_type="EMIT_EVENT",
            effect_ref="relato_criado",
            success=False,
            metadata={
                "payload": {"relato_id": "relato-789", "foo": "bar"}
            },
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_executor.py:84: TypeError
______________________ test_retry_upload_images_success _______________________

executor = <app.services.relato_effect_executor.RelatoEffectExecutor object at 0x000001E711C77FD0>

    def test_retry_upload_images_success(executor):
        """
        Deve reexecutar UploadImagesEffect quando metadata.imagens existe.
        """
        imagens = {
            "antes": ["img1"],
            "durante": ["img2", "img3"],
            "depois": [],
        }
    
>       result = EffectResult(
            relato_id="relato-999",
            effect_type="UPLOAD_IMAGES",
            effect_ref="relato-999",
            success=False,
            metadata={
                "imagens": imagens
            },
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_executor.py:112: TypeError
_______________ test_retry_upload_images_without_metadata_fails _______________

executor = <app.services.relato_effect_executor.RelatoEffectExecutor object at 0x000001E71147B650>

    def test_retry_upload_images_without_metadata_fails(executor):
        """
        UploadImagesEffect sem metadata.imagens deve falhar explicitamente.
        """
>       result = EffectResult(
            relato_id="relato-000",
            effect_type="UPLOAD_IMAGES",
            effect_ref="relato-000",
            success=False,
            metadata=None,
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_executor.py:134: TypeError
____________________ test_retry_unknown_effect_type_fails _____________________

executor = <app.services.relato_effect_executor.RelatoEffectExecutor object at 0x000001E711E6D310>

    def test_retry_unknown_effect_type_fails(executor):
        """
        effect_type desconhecido deve falhar explicitamente.
        """
>       result = EffectResult(
            relato_id="relato-err",
            effect_type="UNKNOWN_EFFECT",
            effect_ref="x",
            success=False,
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_executor.py:150: TypeError
_________________________ test_retry_policy_contract __________________________

    def test_retry_policy_contract():
        policy = DummyPolicy()
    
>       result = EffectResult(
            relato_id="r1",
            effect_type="UPLOAD_IMAGE",
            effect_ref="x",
            success=False,
            metadata=None,
            error="fail",
            executed_at=datetime.utcnow(),
        )
E       TypeError: EffectResult.__init__() got an unexpected keyword argument 'effect_ref'

tests\services\effects\test_retry_policy_contract.py:21: TypeError
___________________________ test_progress_ui_empty ____________________________

    def test_progress_ui_empty():
        progress = {
            "total_effects": 0,
            "completed": 0,
            "failed": 0,
            "progress_pct": 0,
            "effects": [],
        }
    
        ui = build_relato_progress_ui(
            relato_id="relato-1",
            progress=progress,
        )
    
>       assert ui["status"] == "PENDING"
E       AssertionError: assert 'RECEIVED' == 'PENDING'
E         
E         - PENDING
E         + RECEIVED

tests\services\readmodels\test_relato_progress_ui.py:24: AssertionError
_____________________ test_progress_ui_partial_with_error _____________________

    def test_progress_ui_partial_with_error():
        progress = {
            "total_effects": 3,
            "completed": 2,
            "failed": 1,
            "progress_pct": 66,
            "effects": [
                {"effect_type": "PERSIST_RELATO", "success": True},
                {"effect_type": "UPLOAD_IMAGES", "success": False},
                {"effect_type": "ENQUEUE_PROCESSING", "success": True},
            ],
        }
    
        ui = build_relato_progress_ui(
            relato_id="relato-2",
            progress=progress,
        )
    
        assert ui["status"] == "PARTIAL_ERROR"
        assert ui["progress_pct"] == 66
>       assert ui["failed"] == 1
               ^^^^^^^^^^^^
E       KeyError: 'failed'

tests\services\readmodels\test_relato_progress_ui.py:54: KeyError
________________________ test_progress_ui_in_progress _________________________

    def test_progress_ui_in_progress():
        progress = {
            "total_effects": 3,
            "completed": 1,
            "failed": 0,
            "progress_pct": 33,
            "effects": [
                {"effect_type": "PERSIST_RELATO", "success": True},
            ],
        }
    
        ui = build_relato_progress_ui(
            relato_id="relato-3",
            progress=progress,
        )
    
>       assert ui["status"] == "IN_PROGRESS"
E       AssertionError: assert 'PROCESSING' == 'IN_PROGRESS'
E         
E         - IN_PROGRESS
E         + PROCESSING

tests\services\readmodels\test_relato_progress_ui.py:81: AssertionError
_________________________ test_progress_ui_completed __________________________

    def test_progress_ui_completed():
        progress = {
            "total_effects": 2,
            "completed": 2,
            "failed": 0,
            "progress_pct": 100,
            "effects": [
                {"effect_type": "PERSIST_RELATO", "success": True},
                {"effect_type": "UPLOAD_IMAGES", "success": True},
            ],
        }
    
        ui = build_relato_progress_ui(
            relato_id="relato-4",
            progress=progress,
        )
    
        assert ui["status"] == "COMPLETED"
        assert ui["progress_pct"] == 100
>       assert ui["failed"] == 0
               ^^^^^^^^^^^^
E       KeyError: 'failed'

tests\services\readmodels\test_relato_progress_ui.py:110: KeyError
_______________ test_executor_skips_effect_if_already_succeeded _______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001E711849E50>

    def test_executor_skips_effect_if_already_succeeded(monkeypatch):
        """
        Prova que o executor N├âO executa novamente
        um efeito que j├í possui EffectResult success=True.
        """
    
        from app.services.relato_effect_executor import RelatoEffectExecutor
        from app.domain.relato.effects import UploadImagesEffect
    
        # -----------------------------
        # Controle de chamadas
        # -----------------------------
        upload_call_count = 0
    
        def fake_upload(relato_id, imagens):
            nonlocal upload_call_count
            upload_call_count += 1
            return ["img-1", "img-2"]
    
        # -----------------------------
        # Simula idempot├¬ncia ativa
        # -----------------------------
        def fake_effect_already_succeeded(*, relato_id, effect_type, effect_ref):
            # Simula que o efeito J├ü FOI executado com sucesso
            return True
    
        monkeypatch.setattr(
            "app.services.relato_effect_executor.effect_already_succeeded",
            fake_effect_already_succeeded,
        )
    
    
        # -----------------------------
        # Executor real
        # -----------------------------
        executor = RelatoEffectExecutor(
            upload_images=fake_upload,
            rollback_images=None,
            persist_relato=lambda **_: None,
            enqueue_processing=lambda *_: None,
            emit_event=lambda *_: None,
            update_relato_status=lambda *_: None,
        )
    
        effects = [
>           UploadImagesEffect(
                relato_id="relato-123",
                imagens={"antes": [], "durante": [], "depois": []},
            )
        ]
E       TypeError: UploadImagesEffect.__init__() got an unexpected keyword argument 'imagens'

tests\services\test_executor_idempotency.py:48: TypeError
________________________ test_ux_effect_contract_shape ________________________

    def test_ux_effect_contract_shape():
        effect = RetryUXEffect.none_needed(relato_id="r1")
    
>       data = serialize_ux_effects([effect])[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       IndexError: list index out of range

tests\services\test_ux_effects.py:11: IndexError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:28,610", "level": "DEBUG", "logger": "app.services.ux_adapters", "message": "Ignoring non-UX domain effect: RetryUXEffect"}
_________________ test_processing_started_ux_effect_contract __________________

    def test_processing_started_ux_effect_contract():
        effect = ProcessingStartedUXEffect.default(relato_id="r1")
    
>       data = serialize_ux_effects([effect])[0]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       IndexError: list index out of range

tests\services\test_ux_effects.py:24: IndexError
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-01-27 14:12:28,629", "level": "DEBUG", "logger": "app.services.ux_adapters", "message": "Ignoring non-UX domain effect: ProcessingStartedUXEffect"}
________________ test_user_sees_coherent_story_from_ux_effects ________________

    def test_user_sees_coherent_story_from_ux_effects():
        relato_id = "123"
    
        effects = [
            ProcessingStartedUXEffect.default(relato_id=relato_id),
            RetryUXEffect.retrying(relato_id=relato_id, count=1),
            RetryUXEffect.retrying(relato_id=relato_id, count=2),
            RetryUXEffect.failed_final(relato_id=relato_id),
        ]
    
        serialized_effects = [e.serialize() for e in effects]
    
        ui_story = interpret_for_ui(serialized_effects)
    
>       assert ui_story == [
            "Recebemos seu relato",
            "Tentando novamente...",
            "Tentando novamente...",
            "N├úo foi poss├¡vel concluir agora",
        ]
E       AssertionError: assert ['Recebemos s...ncluir agora'] == ['Recebemos s...ncluir agora']
E         
E         At index 1 diff: 'N├úo foi poss├¡vel concluir agora' != 'Tentando novamente...'
E         Right contains 2 more items, first extra item: 'Tentando novamente...'
E         
E         Full diff:
E           [
E               'Recebemos seu relato',...
E         
E         ...Full output truncated (4 lines hidden), use '-vv' to show

tests\ux\test_cognitive_integration_flow.py:30: AssertionError
============================== warnings summary ===============================
tests\auth\test_auth_hardening.py:29
  d:\workspace_projects_001\dermasync-api\tests\auth\test_auth_hardening.py:29: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

tests\auth\test_auth_hardening.py:56
  d:\workspace_projects_001\dermasync-api\tests\auth\test_auth_hardening.py:56: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

tests\auth\test_auth_hardening.py:79
  d:\workspace_projects_001\dermasync-api\tests\auth\test_auth_hardening.py:79: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

tests/auth/test_auth_hardening.py::test_auth_refresh_expired
  D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\passlib\handlers\argon2.py:716: DeprecationWarning: Accessing argon2.__version__ is deprecated and will be removed in a future release. Use importlib.metadata directly to query for argon2-cffi's packaging metadata.
    _argon2_cffi.__version__, max_version)

tests/integration/test_relato_progress_firestore.py::test_effect_result_repository_reads_from_firestore
tests/integration/test_relato_progress_firestore.py::test_progress_service_with_firestore_emulator
tests/routes/test_relatos_progress.py::test_get_relato_progress_forbidden
tests/routes/test_relatos_progress.py::test_get_relato_progress_empty
tests/routes/test_relatos_progress.py::test_get_relato_progress_partial_with_error
tests/routes/test_relatos_progress.py::test_get_relato_progress_complete
  D:\workspace_projects_001\dermasync-api\venv\Lib\site-packages\google\cloud\firestore_v1\base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
    return query.where(field_path, op_string, value)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
--------------------------------- JSON report ---------------------------------
report saved to: report.json
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.11.4-final-0 _______________

Coverage HTML written to dir htmlcov
=========================== short test summary info ===========================
FAILED tests/application/test_relato_progress_stabilization_service.py::test_job_persists_snapshot_when_progress_is_stable
FAILED tests/domain/effects/test_retry_ux_effects.py::test_retry_executes_failed_effects
FAILED tests/domain/effects/test_retry_ux_effects.py::test_retry_endpoint_returns_ux_effect
FAILED tests/domain/enrichment/test_enriched_metadata_v2_validator.py::test_valid_payload_passes_validation
FAILED tests/domain/relato/test_create_relato.py::test_criar_relato_estado_inicial
FAILED tests/domain/relato/test_create_relato.py::test_negar_criacao_relato_existente
FAILED tests/domain/relato/test_create_relato.py::test_post_relatos_success_runs_domain_and_executes_effects
FAILED tests/domain/relato/test_create_relato.py::test_post_relatos_admin_is_allowed_by_domain
FAILED tests/domain/relato/test_create_relato.py::test_create_relato_emits_typed_effects
FAILED tests/domain/relato/test_create_relato.py::test_create_relato_initial_state_is_created
FAILED tests/domain/relato/test_create_relato_decision.py::test_create_relato_allowed_from_initial_state
FAILED tests/domain/relato/test_create_relato_decision.py::test_create_relato_denied_when_already_exists
FAILED tests/domain/relato/test_create_relato_decision.py::test_create_relato_denied_from_any_existing_state
FAILED tests/domain/relato/test_create_relato_decision.py::test_create_relato_effects_structure
FAILED tests/domain/relato/test_invalid_transitions.py::test_negar_aprovacao_estado_draft
FAILED tests/domain/relato/test_invalid_transitions.py::test_negar_rejeicao_estado_draft
FAILED tests/domain/relato/test_invalid_transitions.py::test_negar_marcar_como_processado_estado_draft
FAILED tests/domain/relato/test_submit_relato.py::test_submeter_relato_estado_draft
FAILED tests/domain/ux_effects/test_ux_effect_public_contract.py::test_ux_effect_public_contract_snapshot
FAILED tests/domain/ux_effects/test_ux_effects_composition.py::test_multiple_ux_effects_preserve_order_and_contract
FAILED tests/domain/ux_progress/test_ux_progress.py::test_persist_relato_marks_first_step_done
FAILED tests/domain/ux_progress/test_ux_progress.py::test_upload_images_becomes_active_when_effect_exists_but_not_completed
FAILED tests/domain/ux_progress/test_ux_progress.py::test_upload_images_has_more_weight_in_progress
FAILED tests/domain/ux_progress/test_ux_progress.py::test_error_in_any_step_sets_has_error
FAILED tests/domain/ux_progress/test_ux_progress.py::test_all_steps_done_marks_progress_complete
FAILED tests/infra/retry/test_retry_repository.py::test_load_failed_effect_results_basic
FAILED tests/infra/retry/test_retry_scheduler.py::test_retry_scheduler_runs_and_returns_decisions
FAILED tests/integration/test_relato_progress_firestore.py::test_effect_result_repository_reads_from_firestore
FAILED tests/routes/test_relatos_multipart.py::test_post_relatos_with_real_multipart_upload
FAILED tests/routes/test_relatos_multipart.py::test_upload_failure_triggers_rollback
FAILED tests/routes/test_relatos_multipart.py::test_effect_result_persist_and_fetch_success
FAILED tests/routes/test_relatos_post.py::test_post_relatos_success - Attribu...
FAILED tests/routes/test_relatos_post.py::test_post_relatos_denied_by_domain
FAILED tests/routes/test_relatos_post.py::test_post_relatos_missing_consentimento
FAILED tests/routes/test_relatos_post.py::test_post_relatos_no_consentimento_field
FAILED tests/routes/test_relatos_post.py::test_post_relatos_executor_not_called_when_denied
FAILED tests/routes/test_relatos_progress.py::test_get_relato_progress_forbidden
FAILED tests/routes/test_relatos_progress.py::test_get_relato_progress_empty
FAILED tests/routes/test_relatos_progress.py::test_get_relato_progress_partial_with_error
FAILED tests/routes/test_relatos_progress.py::test_get_relato_progress_complete
FAILED tests/services/effects/test_persist_effect_result_firestore.py::test_persist_effect_result_firestore_accepts_uuid_fields
FAILED tests/services/effects/test_persist_effect_result_firestore.py::test_persist_effect_result_firestore_rejects_raw_uuid_values
FAILED tests/services/effects/test_persist_effect_result_firestore.py::test_persist_effect_result_firestore_normalizes_uuid_before_persisting
FAILED tests/services/effects/test_retry_classifier.py::test_classify_timeout
FAILED tests/services/effects/test_retry_classifier.py::test_classify_invalid_input
FAILED tests/services/effects/test_retry_classifier.py::test_classify_unknown
FAILED tests/services/effects/test_retry_effect.py::test_retry_effect_success
FAILED tests/services/effects/test_retry_effect_unsupported.py::test_retry_effect_unsupported_type_raises
FAILED tests/services/effects/test_retry_executor.py::test_retry_persist_relato
FAILED tests/services/effects/test_retry_executor.py::test_retry_enqueue_processing
FAILED tests/services/effects/test_retry_executor.py::test_retry_emit_event
FAILED tests/services/effects/test_retry_executor.py::test_retry_upload_images_success
FAILED tests/services/effects/test_retry_executor.py::test_retry_upload_images_without_metadata_fails
FAILED tests/services/effects/test_retry_executor.py::test_retry_unknown_effect_type_fails
FAILED tests/services/effects/test_retry_policy_contract.py::test_retry_policy_contract
FAILED tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_empty
FAILED tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_partial_with_error
FAILED tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_in_progress
FAILED tests/services/readmodels/test_relato_progress_ui.py::test_progress_ui_completed
FAILED tests/services/test_executor_idempotency.py::test_executor_skips_effect_if_already_succeeded
FAILED tests/services/test_ux_effects.py::test_ux_effect_contract_shape - Ind...
FAILED tests/services/test_ux_effects.py::test_processing_started_ux_effect_contract
FAILED tests/ux/test_cognitive_integration_flow.py::test_user_sees_coherent_story_from_ux_effects
=========== 63 failed, 90 passed, 2 xfailed, 10 warnings in 56.87s ============
­ƒº╣ Limpando relat├│rios anteriores...
Ô£à Rodando Pytest com cobertura e relat├│rio JSON...


­ƒôè Resumo dos testes:
   Ô£à Passaram: 90
   ÔØî Falharam: 63
   ­ƒº¬ Total:     155

­ƒÜ¿ Alguns testes falharam. Verifique detalhes no report.json e logs_testes.jsonl

­ƒôé Abrindo relat├│rio de cobertura: D:\workspace_projects_001\dermasync-api\htmlcov\index.html

ÔØî Execu├º├úo finalizada com falhas.
